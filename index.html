<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050511">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BudgetFlow Neon</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#050511', // Deep space black
                            800: '#0f1126',
                        },
                        neon: {
                            purple: '#a855f7',
                            cyan: '#06b6d4',
                            pink: '#ec4899',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        blob: "blob 10s infinite",
                        pulse_slow: "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite",
                    },
                    keyframes: {
                        blob: {
                            "0%": { transform: "translate(0px, 0px) scale(1)" },
                            "33%": { transform: "translate(30px, -50px) scale(1.1)" },
                            "66%": { transform: "translate(-20px, 20px) scale(0.9)" },
                            "100%": { transform: "translate(0px, 0px) scale(1)" }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* FIX: Replaced locked overflow with native scrolling */
        html {
            height: 100%;
        }
        body { 
            min-height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Inter', sans-serif;
            background-color: #050511;
            color: #ffffff;
            /* Allow natural scrolling on body */
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        #root {
            min-height: 100%;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        /* Custom Scrollbar - Hidden but scrollable */
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animation */
        .animate-enter { animation: enter 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(8px) scale(0.98); }
        @keyframes enter { to { opacity: 1; transform: translateY(0) scale(1); } }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(20, 20, 35, 0.4);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .glass-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.07) 0%, rgba(255,255,255,0.03) 100%);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .glass-nav {
            background: rgba(10, 10, 20, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .neon-text { text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        
        /* Inputs */
        input, select { 
            background: rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: white; 
        }
        input:focus, select:focus {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
        }
        
        .progress-glow {
            box-shadow: 0 0 10px currentColor;
        }
    </style>
</head>
<body>
    <!-- BACKGROUND ANIMATION (Liquid Blobs) -->
    <div class="fixed inset-0 z-0 overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-600/30 rounded-full mix-blend-screen blur-[100px] animate-blob"></div>
        <div class="absolute top-[20%] right-[-10%] w-96 h-96 bg-cyan-500/20 rounded-full mix-blend-screen blur-[100px] animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-10%] left-[20%] w-96 h-96 bg-pink-600/20 rounded-full mix-blend-screen blur-[100px] animate-blob animation-delay-4000"></div>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ðŸŸ¢ FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCY0D823ZoNP8t5A0LSTk2eZrLiQKVr0XI",
            authDomain: "my-budget-tracker-64883.firebaseapp.com",
            projectId: "my-budget-tracker-64883",
            storageBucket: "my-budget-tracker-64883.firebasestorage.app",
            messagingSenderId: "502096393014",
            appId: "1:502096393014:web:69df0d5bdbba7efd2f3997"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error", e);
        }

        const APP_ID = 'budget-tracker-personal';
        
        const AVAILABLE_ICONS = ['apple', 'shopping-bag', 'home', 'smartphone', 'coffee', 'car', 'dumbbell', 'heart', 'gift', 'plane', 'book', 'briefcase', 'gamepad-2', 'paw-print', 'graduation-cap', 'utensils', 'zap', 'droplet', 'music', 'tv'];

        const INITIAL_CATEGORIES = [
            { id: '1', name: 'Grocery', limit: 70, balance: 70, icon: 'apple', frequency: 'weekly', color: 'text-orange-400' },
            { id: '2', name: 'Shopping', limit: 65, balance: 65, icon: 'shopping-bag', frequency: 'weekly', color: 'text-purple-400' },
            { id: '3', name: 'Rent', limit: 700, balance: 700, icon: 'home', frequency: 'monthly', color: 'text-blue-400' },
            { id: '4', name: 'Phone', limit: 65, balance: 65, icon: 'smartphone', frequency: 'monthly', color: 'text-emerald-400' },
        ];

        // --- Crash-Proof Icon Component ---
        const Icon = ({ name, size = 24, className }) => {
            const ref = React.useRef(null);
            React.useEffect(() => {
                if (!ref.current || !window.lucide) return;
                ref.current.innerHTML = '';
                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                ref.current.appendChild(i);
                window.lucide.createIcons({
                    root: ref.current,
                    nameAttr: 'data-lucide',
                    attrs: { width: size, height: size, class: className }
                });
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center pointer-events-none"></span>;
        };

        function App() {
            // State
            const [user, setUser] = React.useState(null);
            const [isOffline, setIsOffline] = React.useState(true);
            const [loading, setLoading] = React.useState(true);
            const [categories, setCategories] = React.useState([]);
            const [transactions, setTransactions] = React.useState([]);
            const [weeksTracked, setWeeksTracked] = React.useState(1);
            
            const [view, setView] = React.useState('dashboard');
            
            const [newTransaction, setNewTransaction] = React.useState({ categoryId: '', amount: '', description: '', type: 'expense' });
            const [transferData, setTransferData] = React.useState({ fromId: '', toId: '', amount: '' });
            
            const [searchQuery, setSearchQuery] = React.useState('');
            const [showWeekModal, setShowWeekModal] = React.useState(false);
            const [isNewMonth, setIsNewMonth] = React.useState(false);
            const [showResetConfirm, setShowResetConfirm] = React.useState(false);
            
            const [editingCategory, setEditingCategory] = React.useState(null);
            const [editForm, setEditForm] = React.useState({ limit: '', balance: '' });
            
            const [showAddCat, setShowAddCat] = React.useState(false);
            const [newCatForm, setNewCatForm] = React.useState({ name: '', limit: '', icon: 'shopping-bag', frequency: 'weekly' });

            const [now, setNow] = React.useState(new Date());
            const fileInputRef = React.useRef(null);

            // --- Auth & Data ---
            React.useEffect(() => {
                if (!auth) { setLoading(false); return; }
                signInAnonymously(auth).catch(() => { setIsOffline(true); setLoading(false); });
                return onAuthStateChanged(auth, u => { if (u) { setUser(u); setIsOffline(false); } });
            }, []);

            React.useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 60000);
                return () => clearInterval(timer);
            }, []);

            React.useEffect(() => {
                if (isOffline) {
                    try {
                        const savedCats = localStorage.getItem('budget_cats_v13');
                        const savedTx = localStorage.getItem('budget_tx_v13');
                        const savedMeta = localStorage.getItem('budget_meta_v13');
                        setCategories(savedCats ? JSON.parse(savedCats) : INITIAL_CATEGORIES);
                        setTransactions(savedTx ? JSON.parse(savedTx) : []);
                        setWeeksTracked(savedMeta ? parseInt(savedMeta) : 1);
                    } catch(e) { setCategories(INITIAL_CATEGORIES); }
                    setLoading(false);
                    return;
                }

                if (!user) return;

                const unsubCat = onSnapshot(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'categories'), snap => {
                    const loaded = snap.docs.map(d => d.data());
                    if (loaded.length > 0) setCategories(loaded.sort((a,b) => a.id.localeCompare(b.id)));
                    else checkMigration();
                    setLoading(false);
                }, () => { setIsOffline(true); setLoading(false); });

                const unsubTx = onSnapshot(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions'), snap => {
                    const loaded = snap.docs.map(d => d.data());
                    setTransactions(loaded.sort((a,b) => new Date(b.date) - new Date(a.date)));
                });

                const unsubMeta = onSnapshot(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'meta', 'weeks'), snap => {
                    if (snap.exists()) setWeeksTracked(snap.data().count);
                });

                return () => { unsubCat(); unsubTx(); unsubMeta(); };
            }, [user, isOffline]);

            const checkMigration = async () => {
                const batch = writeBatch(db);
                INITIAL_CATEGORIES.forEach(c => batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', c.id), c));
                batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'meta', 'weeks'), { count: 1 });
                await batch.commit();
            };

            const saveLocal = (c, t, w) => {
                localStorage.setItem('budget_cats_v13', JSON.stringify(c));
                localStorage.setItem('budget_tx_v13', JSON.stringify(t));
                localStorage.setItem('budget_meta_v13', w.toString());
            };

            // --- Handlers ---
            const handleAdd = async (e) => {
                e.preventDefault();
                const cat = categories.find(c => c.id === newTransaction.categoryId);
                if (!cat) return;
                const amt = parseFloat(newTransaction.amount);
                const isExpense = (newTransaction.type || 'expense') === 'expense';
                const newBalance = isExpense ? cat.balance - amt : cat.balance + amt;
                
                const tx = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    amount: amt,
                    description: newTransaction.description || (isExpense ? 'Expense' : 'Income'),
                    categoryId: cat.id,
                    categoryName: cat.name,
                    type: isExpense ? 'expense' : 'income'
                };

                if (isOffline) {
                    const newCats = categories.map(c => c.id === cat.id ? {...c, balance: newBalance} : c);
                    const newTx = [tx, ...transactions];
                    setCategories(newCats); setTransactions(newTx);
                    saveLocal(newCats, newTx, weeksTracked);
                } else {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', cat.id), { ...cat, balance: newBalance });
                    await setDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions', tx.id), tx);
                }
                setNewTransaction({ categoryId: '', amount: '', description: '', type: 'expense' });
                setView('dashboard');
            };

            const handleTransfer = async (e) => {
                e.preventDefault();
                const fromCat = categories.find(c => c.id === transferData.fromId);
                const toCat = categories.find(c => c.id === transferData.toId);
                const amt = parseFloat(transferData.amount);
                if (!fromCat || !toCat || isNaN(amt) || amt <= 0) return;

                const newFromBalance = fromCat.balance - amt;
                const newToBalance = toCat.balance + amt;
                const tx = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    amount: 0,
                    description: `Transfer: ${fromCat.name} -> ${toCat.name} ($${amt})`,
                    categoryId: 'system',
                    categoryName: 'Transfer',
                    type: 'transfer'
                };

                if (isOffline) {
                    const newCats = categories.map(c => {
                        if (c.id === fromCat.id) return { ...c, balance: newFromBalance };
                        if (c.id === toCat.id) return { ...c, balance: newToBalance };
                        return c;
                    });
                    const newTx = [tx, ...transactions];
                    setCategories(newCats); setTransactions(newTx);
                    saveLocal(newCats, newTx, weeksTracked);
                } else {
                    const batch = writeBatch(db);
                    batch.update(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', fromCat.id), { balance: newFromBalance });
                    batch.update(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', toCat.id), { balance: newToBalance });
                    batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions', tx.id), tx);
                    await batch.commit();
                }
                setTransferData({ fromId: '', toId: '', amount: '' });
                setView('dashboard');
            };

            const handleCreateCategory = async (e) => {
                e.preventDefault();
                const newId = Date.now().toString();
                const newCat = {
                    id: newId,
                    name: newCatForm.name,
                    limit: parseFloat(newCatForm.limit) || 0,
                    balance: parseFloat(newCatForm.limit) || 0,
                    icon: newCatForm.icon,
                    frequency: newCatForm.frequency,
                    color: 'text-white'
                };
                if(isOffline) {
                    const newCats = [...categories, newCat];
                    setCategories(newCats); saveLocal(newCats, transactions, weeksTracked);
                } else {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', newId), newCat);
                }
                setShowAddCat(false);
                setNewCatForm({ name: '', limit: '', icon: 'shopping-bag', frequency: 'weekly' });
            };

            const handleDeleteCategory = async (id) => {
                if(!confirm("Delete this category?")) return;
                if(isOffline) {
                    const newCats = categories.filter(c => c.id !== id);
                    setCategories(newCats); saveLocal(newCats, transactions, weeksTracked);
                } else {
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', id));
                }
                setEditingCategory(null);
            };

            const handleWeekReset = async () => {
                let newCats = [...categories];
                newCats = newCats.map(c => {
                    if (c.frequency === 'weekly' || (c.frequency === 'monthly' && isNewMonth)) {
                        return { ...c, balance: c.balance + c.limit };
                    }
                    return c;
                });
                const nextWeek = weeksTracked + 1;
                const log = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    amount: 0,
                    description: `Started Week ${nextWeek} ${isNewMonth ? '(+Month)' : ''}`,
                    categoryId: 'system',
                    categoryName: 'System',
                    type: 'system'
                };
                if (isOffline) {
                    setCategories(newCats); setWeeksTracked(nextWeek); setTransactions([log, ...transactions]);
                    saveLocal(newCats, [log, ...transactions], nextWeek);
                } else {
                    const batch = writeBatch(db);
                    newCats.forEach(c => batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', c.id), c));
                    batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'meta', 'weeks'), { count: nextWeek });
                    batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions', log.id), log);
                    await batch.commit();
                }
                setShowWeekModal(false); setIsNewMonth(false);
            };

            const handleUpdateCategory = async (id) => {
                const lim = parseFloat(editForm.limit);
                const bal = parseFloat(editForm.balance);
                if (isNaN(lim) || lim < 0 || isNaN(bal)) return;
                if(isOffline) {
                    const newCats = categories.map(c => c.id === id ? {...c, limit: lim, balance: bal} : c);
                    setCategories(newCats); saveLocal(newCats, transactions, weeksTracked);
                } else {
                    const cat = categories.find(c => c.id === id);
                    if(cat) await setDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', id), { ...cat, limit: lim, balance: bal });
                }
                setEditingCategory(null);
            };

            const startEdit = (cat) => {
                setEditingCategory(cat.id);
                setEditForm({ limit: cat.limit, balance: cat.balance });
            };

            const performReset = async () => {
                if(isOffline) {
                    localStorage.clear(); window.location.reload();
                } else {
                    const batch = writeBatch(db);
                    categories.forEach(c => {
                        const def = INITIAL_CATEGORIES.find(ic => ic.id === c.id) || c;
                        batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', c.id), { ...def, balance: def.limit });
                    });
                    transactions.forEach(t => batch.delete(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions', t.id)));
                    batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'meta', 'weeks'), { count: 1 });
                    await batch.commit();
                    setShowResetConfirm(false); setView('dashboard');
                }
            };

            const handleExport = () => {
                const rows = [["Date","Description","Category","Amount","Type"], ...transactions.map(t => [
                    new Date(t.date).toLocaleDateString(), `"${t.description.replace(/"/g, '""')}"`, t.categoryName, t.amount, t.type || 'expense'
                ])];
                const csv = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
                const link = document.createElement("a");
                link.href = encodeURI(csv); link.download = `budget_export.csv`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.categories || !data.transactions) throw new Error("Invalid backup file");
                        if(!confirm("This will overwrite your current data. Continue?")) return;

                        if (isOffline) {
                            setCategories(data.categories);
                            setTransactions(data.transactions);
                            setWeeksTracked(data.weeksTracked || 1);
                            saveLocal(data.categories, data.transactions, data.weeksTracked || 1);
                        } else {
                            const batch = writeBatch(db);
                            data.categories.forEach(c => batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', c.id), c));
                            data.transactions.forEach(t => batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions', t.id), t));
                            batch.set(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'meta', 'weeks'), { count: data.weeksTracked || 1 });
                            await batch.commit();
                        }
                        alert("Data restored!");
                        window.location.reload();
                    } catch (err) {
                        alert("Error: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const handleBackupJSON = () => {
                const data = { categories, transactions, weeksTracked };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `budget_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleDeleteTransaction = async (id) => {
                const tx = transactions.find(t => t.id === id);
                if (!tx) return;
                let newBalance = 0;
                let catId = tx.categoryId;
                const cat = categories.find(c => c.id === catId);
                if (tx.type === 'transfer') {
                    if(!confirm("Deleting transfer does NOT undo balance change. Proceed?")) return;
                } else if(cat) {
                    const isExpense = tx.type !== 'income';
                    newBalance = isExpense ? cat.balance + parseFloat(tx.amount) : cat.balance - parseFloat(tx.amount);
                }
                if(isOffline) {
                    const newTx = transactions.filter(t => t.id !== id);
                    let newCats = categories;
                    if(cat && tx.type !== 'transfer') newCats = categories.map(c => c.id === cat.id ? {...c, balance: newBalance} : c);
                    setTransactions(newTx); setCategories(newCats);
                    saveLocal(newCats, newTx, weeksTracked);
                } else {
                    if(cat && tx.type !== 'transfer') await setDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'categories', cat.id), { ...cat, balance: newBalance });
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions', id));
                }
            };

            // --- Stats ---
            const totalFunds = categories.reduce((sum, c) => sum + c.balance, 0);
            
            const calendarData = React.useMemo(() => {
                const d = new Date(now);
                const currentDay = d.getDate();
                const dayOfWeek = d.getDay(); 
                const startDiff = d.getDate() - dayOfWeek;
                const startOfWeek = new Date(d);
                startOfWeek.setDate(startDiff);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                const fmt = (date) => date.toLocaleDateString(undefined, {month:'short', day:'numeric'});

                return { 
                    day: currentDay, 
                    week: Math.ceil(currentDay/7), 
                    month: now.toLocaleString('default', {month:'short'}),
                    range: `${fmt(startOfWeek)} - ${fmt(endOfWeek)}`
                };
            }, [now]);

            const weeklyTrend = React.useMemo(() => {
                const days = [];
                for(let i=6; i>=0; i--) {
                    const d = new Date(now); d.setDate(now.getDate() - i);
                    days.push({ date: d, label: d.toLocaleDateString('en-US', {weekday:'short'}), total: 0 });
                }
                transactions.forEach(t => {
                    if(!t.date || t.categoryId === 'system' || t.type === 'income' || t.type === 'transfer') return;
                    const td = new Date(t.date);
                    const ds = days.find(d => d.date.getDate() === td.getDate() && d.date.getMonth() === td.getMonth());
                    if(ds) ds.total += parseFloat(t.amount);
                });
                const max = Math.max(...days.map(d => d.total), 1);
                return days.map(d => ({...d, pct: max === 0 ? 0 : (d.total/max)*100}));
            }, [transactions, now]);

            const monthlyBreakdown = React.useMemo(() => {
                const groups = {};
                transactions.forEach(t => {
                    if(!t.date || t.categoryId === 'system' || t.type === 'income' || t.type === 'transfer') return;
                    const d = new Date(t.date);
                    const k = `${d.toLocaleString('default', {month:'long'})} ${d.getFullYear()}`;
                    if(!groups[k]) groups[k] = {total:0, cats:{}};
                    groups[k].total += parseFloat(t.amount);
                    if(!groups[k].cats[t.categoryName]) groups[k].cats[t.categoryName] = 0;
                    groups[k].cats[t.categoryName] += parseFloat(t.amount);
                });
                return Object.entries(groups).sort((a,b) => new Date(b[0]) - new Date(a[0]));
            }, [transactions]);

            const monthlyTotal = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === now.getMonth() && t.categoryId !== 'system' && t.type !== 'income' && t.type !== 'transfer';
            }).reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const filteredTransactions = transactions.filter(t => 
                t.description.toLowerCase().includes(searchQuery.toLowerCase()) || 
                t.categoryName.toLowerCase().includes(searchQuery.toLowerCase())
            );

            if (loading) return <div className="flex h-screen items-center justify-center text-slate-500 font-bold bg-dark-900 gap-2"><Icon name="loader-2" className="animate-spin text-neon-cyan" /></div>;

            // --- UI ---
            return (
                <div className="pb-32 max-w-md mx-auto min-h-screen relative">
                    
                    {/* Header */}
                    <div className="sticky top-0 glass-panel border-b-0 p-4 flex justify-between items-center z-50 rounded-b-3xl mx-2 mt-2">
                        <div className="flex items-center gap-2.5 font-bold tracking-tight">
                            <div className="bg-gradient-to-tr from-neon-purple to-neon-cyan text-white p-2 rounded-xl shadow-lg shadow-neon-purple/30"><Icon name="wallet" size={20} /></div>
                            <span className="text-lg neon-text">BudgetFlow</span>
                            {isOffline && <span className="text-[10px] bg-orange-500/10 text-orange-400 px-2 py-0.5 rounded-full border border-orange-500/20 font-bold flex items-center gap-1"><Icon name="wifi-off" size={10} /></span>}
                        </div>
                        <button onClick={() => setShowWeekModal(true)} className="glass-card text-xs font-bold px-4 py-2 rounded-full active:scale-95 transition-transform flex items-center gap-2 text-slate-300 hover:bg-white/10">
                            Cycle {weeksTracked} <Icon name="chevron-right" size={14} className="opacity-50" />
                        </button>
                    </div>

                    <div className="p-5 space-y-6 relative z-10">
                        
                        {/* DASHBOARD */}
                        {view === 'dashboard' && (
                            <div className="animate-enter">
                                <div className="glass-card p-7 rounded-[2.5rem] mb-6 relative overflow-hidden group border-white/10">
                                    <div className="absolute -top-12 -right-12 p-8 opacity-[0.2] group-hover:scale-110 transition-transform duration-700 rotate-12 text-neon-cyan"><Icon name="credit-card" size={200} /></div>
                                    <div className="relative z-10">
                                        <div className="flex justify-between items-start mb-3">
                                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest flex items-center gap-2">Total Balance</p>
                                            <div className={`px-2.5 py-1 rounded-full text-[10px] font-bold border border-white/10 backdrop-blur-md shadow-sm ${totalFunds < 0 ? 'bg-rose-500/20 text-rose-300' : 'bg-emerald-500/20 text-emerald-300'}`}>
                                                {totalFunds < 0 ? 'Overdraft' : 'Healthy'}
                                            </div>
                                        </div>
                                        <h2 className="text-5xl font-black mb-6 tracking-tight drop-shadow-sm text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400">${totalFunds.toFixed(0)}</h2>
                                        <div className="flex gap-3">
                                            <div className="bg-white/5 backdrop-blur-md px-4 py-3 rounded-2xl border border-white/5 flex flex-col items-start min-w-[90px] flex-1">
                                                <span className="text-[10px] text-neon-cyan font-bold uppercase tracking-wider flex items-center gap-1.5 opacity-90"><Icon name="calendar" size={10} /> Week {calendarData.week}</span>
                                                <span className="text-xs font-bold text-white whitespace-nowrap mt-1">{calendarData.range}</span>
                                            </div>
                                            <div className="bg-white/5 backdrop-blur-md px-4 py-3 rounded-2xl border border-white/5 flex flex-col items-start flex-1">
                                                <span className="text-[10px] text-neon-pink font-bold uppercase tracking-wider flex items-center gap-1.5 opacity-90"><Icon name="bar-chart-3" size={10} /> Spent</span>
                                                <span className="text-xs font-bold text-white mt-1">${monthlyTotal.toFixed(0)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="space-y-4">
                                    {categories.map(cat => {
                                        const pct = Math.min(100, Math.max(0, (cat.balance / cat.limit) * 100));
                                        const isLow = cat.balance < 0;
                                        return (
                                            <div key={cat.id} className={`glass-card p-5 rounded-3xl transition-all duration-300 hover:bg-white/5 ${isLow ? 'border-rose-500/30 shadow-[0_0_20px_rgba(244,63,94,0.15)]' : ''}`}>
                                                <div className="flex justify-between items-start mb-4 relative z-10">
                                                    <div className="flex items-center gap-4">
                                                        <div className={`p-3.5 rounded-2xl ${cat.color} bg-white/5 backdrop-blur-sm border border-white/5 shadow-inner`}><Icon name={cat.icon} /></div>
                                                        <div>
                                                            <h3 className="font-bold text-slate-100 text-lg leading-tight tracking-tight">{cat.name}</h3>
                                                            <p className="text-xs text-slate-400 font-bold uppercase tracking-wide mt-1">{cat.frequency}</p>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className={`block text-2xl font-black tracking-tight ${isLow ? 'text-rose-400 neon-text' : 'text-slate-100'}`}>${cat.balance.toFixed(0)}</span>
                                                        <span className={`text-[10px] font-bold uppercase tracking-widest ${isLow ? 'text-rose-500' : 'text-slate-500'}`}>{isLow ? 'Overdrawn' : 'Left'}</span>
                                                    </div>
                                                </div>
                                                <div className="h-3 w-full bg-dark-800 rounded-full overflow-hidden shadow-inner relative ring-1 ring-white/5">
                                                    <div className={`h-full transition-all duration-1000 ease-out rounded-full shadow-[0_0_15px_currentColor] progress-striped ${isLow ? 'bg-rose-500 text-rose-500 w-full opacity-60' : 'bg-neon-cyan text-neon-cyan'}`} style={{width: isLow ? '100%' : `${pct}%`}}></div>
                                                </div>
                                                <div className="flex justify-between mt-3 text-xs font-semibold text-slate-500">
                                                    <span>Goal: ${cat.limit}</span>
                                                    {isLow && <span className="text-rose-400 flex items-center gap-1.5 animate-pulse"><Icon name="alert-triangle" size={12}/> Excess carries over</span>}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>

                                {/* Recent Activity on Dashboard */}
                                <div className="mt-10">
                                    <div className="flex justify-between items-end mb-4 px-2">
                                        <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Recent Activity</h3>
                                        <button onClick={() => setView('history')} className="text-xs font-bold text-neon-cyan hover:text-cyan-300 transition-colors">View All</button>
                                    </div>
                                    <div className="space-y-2">
                                        {transactions.slice(0,3).map(t => (
                                            <div key={t.id} className="glass-card p-3.5 rounded-2xl flex justify-between items-center group hover:bg-white/5 transition-colors">
                                                <div className="flex items-center gap-3.5">
                                                    <div className={`p-2.5 rounded-xl ${t.type==='income'?'bg-emerald-500/10 text-emerald-400':t.type==='transfer'?'bg-blue-500/10 text-blue-400':'bg-white/5 text-slate-400'}`}><Icon name={t.type==='income'?'arrow-down':t.type==='transfer'?'arrow-right-left':'arrow-up'} size={16}/></div>
                                                    <div>
                                                        <span className="font-bold text-sm text-slate-200 block">{t.description}</span>
                                                        <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wide">{t.categoryName}</span>
                                                    </div>
                                                </div>
                                                <span className={`font-bold text-sm ${t.type==='income'?'text-emerald-400':'text-slate-100'}`}>${parseFloat(t.amount).toFixed(0)}</span>
                                            </div>
                                        ))}
                                        {transactions.length === 0 && <div className="text-xs text-slate-500 text-center py-6 border border-dashed border-slate-800 rounded-2xl">No recent transactions</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ADD TRANSACTION / TRANSFER */}
                        {view === 'add' && (
                            <div className="glass-card p-6 rounded-[2.5rem] mt-4 animate-enter border-t border-white/10">
                                <h2 className="text-2xl font-black text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400">New Entry</h2>
                                
                                <div className="flex bg-dark-900/50 p-1.5 rounded-2xl mb-8 border border-white/5">
                                    <button onClick={() => setNewTransaction({...newTransaction, type: 'expense'})} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${newTransaction.type === 'expense' ? 'bg-slate-700 text-white shadow-lg shadow-black/40' : 'text-slate-500 hover:text-slate-300'}`}>Expense</button>
                                    <button onClick={() => setNewTransaction({...newTransaction, type: 'income'})} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${newTransaction.type === 'income' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/40' : 'text-slate-500 hover:text-slate-300'}`}>Income</button>
                                    <button onClick={() => setNewTransaction({...newTransaction, type: 'transfer'})} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${newTransaction.type === 'transfer' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/40' : 'text-slate-500 hover:text-slate-300'}`}>Transfer</button>
                                </div>

                                {newTransaction.type === 'transfer' ? (
                                    <form onSubmit={handleTransfer} className="space-y-6">
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-xs font-bold text-slate-500 uppercase mb-2.5 block ml-1">From</label>
                                                <select className="w-full p-4 bg-dark-800 border border-white/5 rounded-2xl outline-none font-bold text-slate-200 focus:border-neon-purple/50 focus:shadow-[0_0_15px_rgba(168,85,247,0.15)] transition-all appearance-none" value={transferData.fromId} onChange={e => setTransferData({...transferData, fromId: e.target.value})}>
                                                    <option value="">Select Source</option>
                                                    {categories.map(c => <option key={c.id} value={c.id}>{c.name} (${c.balance})</option>)}
                                                </select>
                                            </div>
                                            <div className="flex justify-center"><div className="bg-white/5 p-3 rounded-full border border-white/5 backdrop-blur-sm"><Icon name="arrow-down" size={20} className="text-slate-400" /></div></div>
                                            <div>
                                                <label className="text-xs font-bold text-slate-500 uppercase mb-2.5 block ml-1">To</label>
                                                <select className="w-full p-4 bg-dark-800 border border-white/5 rounded-2xl outline-none font-bold text-slate-200 focus:border-neon-purple/50 focus:shadow-[0_0_15px_rgba(168,85,247,0.15)] transition-all appearance-none" value={transferData.toId} onChange={e => setTransferData({...transferData, toId: e.target.value})}>
                                                    <option value="">Select Destination</option>
                                                    {categories.map(c => <option key={c.id} value={c.id}>{c.name} (${c.balance})</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-slate-500 uppercase mb-2.5 block ml-1">Amount</label>
                                                <input type="number" step="0.01" className="w-full p-4 bg-dark-800 border border-white/5 rounded-2xl outline-none font-black text-2xl text-white placeholder-slate-600 focus:border-neon-purple/50 focus:shadow-[0_0_15px_rgba(168,85,247,0.15)] transition-all" placeholder="0.00" value={transferData.amount} onChange={e => setTransferData({...transferData, amount: e.target.value})} />
                                            </div>
                                        </div>
                                        <button type="submit" disabled={!transferData.fromId || !transferData.toId || !transferData.amount} className="w-full py-4 bg-neon-purple hover:bg-purple-500 text-white font-bold rounded-2xl shadow-[0_0_20px_rgba(168,85,247,0.3)] disabled:opacity-50 disabled:shadow-none transition-all mt-4">Move Funds</button>
                                    </form>
                                ) : (
                                    <form onSubmit={handleAdd} className="space-y-6">
                                        <div className="grid grid-cols-2 gap-3">
                                            {categories.map(c => (
                                                <button type="button" key={c.id} onClick={() => setNewTransaction({...newTransaction, categoryId: c.id})} 
                                                    className={`p-4 rounded-2xl border transition-all duration-200 flex flex-col items-center gap-2 ${newTransaction.categoryId === c.id ? 'border-neon-cyan bg-cyan-500/10 text-cyan-200 shadow-[0_0_15px_rgba(6,182,212,0.2)]' : 'border-white/5 bg-white/5 text-slate-500 hover:bg-white/10'}`}>
                                                    <span className="text-2xl"><Icon name={c.icon} /></span>
                                                    <span className="text-xs font-bold">{c.name}</span>
                                                </button>
                                            ))}
                                        </div>

                                        <div className="relative group">
                                            <span className={`absolute left-5 top-1/2 -translate-y-1/2 font-bold text-2xl transition-colors ${newTransaction.type === 'income' ? 'text-emerald-500' : 'text-slate-500 group-focus-within:text-neon-cyan'}`}>$</span>
                                            <input type="number" step="0.01" required value={newTransaction.amount} onChange={(e) => setNewTransaction({...newTransaction, amount: e.target.value})} className="w-full pl-12 pr-4 py-5 text-4xl font-black text-white bg-dark-800 border border-white/5 rounded-2xl focus:border-neon-cyan/50 focus:shadow-[0_0_15px_rgba(6,182,212,0.15)] outline-none transition-all placeholder-slate-700" placeholder="0.00" />
                                        </div>

                                        <input type="text" value={newTransaction.description} onChange={(e) => setNewTransaction({...newTransaction, description: e.target.value})} className="w-full p-4 font-semibold text-white bg-dark-800 border border-white/5 rounded-2xl focus:border-neon-cyan/50 focus:shadow-[0_0_15px_rgba(6,182,212,0.15)] outline-none transition-all placeholder-slate-600" placeholder="Note (e.g. Walmart)" />

                                        <div className="flex gap-3 pt-4">
                                            <button type="button" onClick={() => setView('dashboard')} className="flex-1 py-4 font-bold text-slate-500 hover:bg-white/10 rounded-2xl transition-colors">Cancel</button>
                                            <button type="submit" disabled={!newTransaction.categoryId || !newTransaction.amount} className={`flex-[2] text-white font-bold py-4 rounded-2xl shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2 ${newTransaction.type === 'income' ? 'bg-emerald-600 hover:bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.3)]' : 'bg-neon-cyan hover:bg-cyan-400 shadow-[0_0_20px_rgba(6,182,212,0.3)] text-black'} disabled:bg-slate-800 disabled:text-slate-600 disabled:shadow-none`}>
                                                {newTransaction.type === 'income' ? 'Add Funds' : 'Save Expense'} <Icon name="check" size={18} />
                                            </button>
                                        </div>
                                    </form>
                                )}
                            </div>
                        )}

                        {/* SETTINGS (Manage Categories & Backup) */}
                        {view === 'settings' && (
                            <div className="space-y-4 animate-enter">
                                <h2 className="text-2xl font-black px-1 mb-6 text-white">Settings</h2>
                                
                                <div className="grid grid-cols-2 gap-3 mb-6">
                                    <button onClick={handleBackupJSON} className="glass-card p-4 rounded-2xl flex flex-col items-center gap-2 text-emerald-400 hover:bg-emerald-500/10 transition-colors border-emerald-500/20">
                                        <Icon name="save" />
                                        <span className="text-xs font-bold">Backup (Save)</span>
                                    </button>
                                    <button onClick={() => fileInputRef.current.click()} className="glass-card p-4 rounded-2xl flex flex-col items-center gap-2 text-cyan-400 hover:bg-cyan-500/10 transition-colors border-cyan-500/20">
                                        <Icon name="upload-cloud" />
                                        <span className="text-xs font-bold">Restore (Load)</span>
                                        <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" accept=".json" />
                                    </button>
                                </div>

                                <button onClick={handleExport} className="w-full glass-card p-5 rounded-2xl flex items-center justify-between group active:scale-[0.98] transition-all hover:bg-white/5">
                                    <div className="flex gap-4 items-center">
                                        <div className="bg-slate-800 text-slate-400 p-3 rounded-xl"><Icon name="file-spreadsheet" /></div>
                                        <div className="text-left"><p className="font-bold text-slate-200">Export Excel</p><p className="text-xs text-slate-500 font-medium">Download CSV</p></div>
                                    </div>
                                    <Icon name="chevron-right" className="text-slate-600 group-hover:text-slate-400" />
                                </button>

                                <div className="flex justify-between items-end px-2 pt-6 pb-2">
                                    <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Manage Envelopes</h3>
                                    <button onClick={() => setShowAddCat(true)} className="text-xs font-bold text-neon-purple bg-purple-500/10 border border-purple-500/20 px-4 py-1.5 rounded-full hover:bg-purple-500/20 transition-colors">+ Add New</button>
                                </div>

                                <div className="space-y-3">
                                    {categories.map(cat => (
                                        <div key={cat.id} className="glass-card p-4 rounded-2xl flex flex-col gap-3">
                                            <div className="flex justify-between items-center w-full">
                                                <div className="flex items-center gap-4">
                                                    <div className="text-2xl opacity-80 text-slate-400"><Icon name={cat.icon} /></div>
                                                    <div><p className="font-bold text-slate-200">{cat.name}</p><p className="text-xs text-slate-500 font-bold uppercase">{cat.frequency}</p></div>
                                                </div>
                                                {editingCategory !== cat.id && (
                                                    <button onClick={() => startEdit(cat)} className="bg-white/5 px-4 py-2 rounded-xl text-sm font-bold text-slate-400 flex items-center gap-2 hover:bg-white/10 hover:text-white transition-colors border border-white/5">
                                                        Edit <Icon name="edit-2" size={14} className="opacity-50"/>
                                                    </button>
                                                )}
                                            </div>

                                            {editingCategory === cat.id && (
                                                <div className="bg-black/30 p-4 rounded-xl border border-white/5 mt-2 animate-enter">
                                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                                        <div><label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Balance</label><input type="number" className="w-full pl-3 p-2 rounded-lg bg-dark-800 border border-white/10 font-bold text-white focus:border-neon-cyan outline-none" value={editForm.balance} onChange={e => setEditForm({...editForm, balance: e.target.value})} /></div>
                                                        <div><label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Limit</label><input type="number" className="w-full pl-3 p-2 rounded-lg bg-dark-800 border border-white/10 font-bold text-white focus:border-neon-cyan outline-none" value={editForm.limit} onChange={e => setEditForm({...editForm, limit: e.target.value})} /></div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleDeleteCategory(cat.id)} className="p-2 text-rose-400 bg-rose-900/20 rounded-lg hover:bg-rose-900/40"><Icon name="trash-2" size={18} /></button>
                                                        <button onClick={() => setEditingCategory(null)} className="flex-1 py-2 font-bold text-slate-400 hover:bg-white/10 rounded-lg">Cancel</button>
                                                        <button onClick={() => handleUpdateCategory(cat.id)} className="flex-1 py-2 bg-neon-cyan text-black font-bold rounded-lg shadow-md hover:bg-cyan-400">Save</button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                <div className="pt-8"><button onClick={() => setShowResetConfirm(true)} className="w-full p-4 text-rose-400 bg-rose-900/10 border border-rose-900/20 rounded-2xl font-bold flex justify-center gap-2 hover:bg-rose-900/20 transition-colors"><Icon name="trash-2" /> Reset All Data</button></div>
                            </div>
                        )}
                        
                        {/* ANALYSIS (Breakdown) */}
                        {view === 'breakdown' && (
                            <div className="animate-enter">
                                <h2 className="text-2xl font-black mb-6 text-white px-1">Analysis</h2>
                                <div className="glass-card p-6 rounded-3xl mb-6">
                                    <div className="mb-6 font-bold text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wide"><Icon name="trending-down" size={18} className="text-neon-purple"/> Spending (Last 7 Days)</div>
                                    <div className="flex items-end justify-between h-32 gap-2">
                                        {weeklyTrend.map((d, i) => (
                                            <div key={i} className="flex flex-col items-center gap-2 flex-1 group cursor-pointer">
                                                <div className="w-full relative h-full flex items-end">
                                                    <div className="w-full bg-neon-purple/20 rounded-t-lg transition-all duration-300 group-hover:bg-neon-purple/40 relative" style={{height:`${d.pct}%`}}>
                                                        <div className={`absolute bottom-0 w-full rounded-t-lg bg-neon-purple transition-all duration-500 shadow-[0_0_10px_currentColor]`} style={{height: '4px'}}></div>
                                                    </div>
                                                </div>
                                                <span className="text-[10px] font-bold text-slate-500 uppercase group-hover:text-neon-purple transition-colors">{d.label}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {monthlyBreakdown.length === 0 ? <div className="p-10 text-center text-slate-500 border-2 border-dashed border-slate-800 rounded-3xl font-medium">No spending data yet.</div> : 
                                    <div className="space-y-6">
                                        {monthlyBreakdown.map(([month, data]) => (
                                            <div key={month} className="glass-card rounded-3xl overflow-hidden shadow-sm">
                                                <div className="p-4 bg-white/5 border-b border-white/5 flex justify-between items-center font-bold text-slate-200">
                                                    <span className="text-lg">{month}</span>
                                                    <span className="bg-neon-purple/20 text-purple-300 px-3 py-1 rounded-full text-sm border border-purple-500/20">${data.total.toFixed(2)}</span>
                                                </div>
                                                <div className="p-2">
                                                    {Object.entries(data.cats).map(([c, amt]) => (
                                                        <div key={c} className="flex justify-between items-center p-3 text-sm hover:bg-white/5 rounded-xl transition-colors">
                                                            <div className="flex items-center gap-3"><div className="w-2 h-2 bg-neon-cyan rounded-full shadow-[0_0_8px_currentColor]"></div><span className="font-medium text-slate-400">{c}</span></div>
                                                            <span className="font-bold text-slate-200">${amt.toFixed(2)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                }
                            </div>
                        )}
                        
                        {/* HISTORY (Search) */}
                        {view === 'history' && (
                            <div className="animate-enter">
                                <div className="flex justify-between items-center mb-6 px-1">
                                    <h2 className="text-2xl font-black text-white">History</h2>
                                </div>
                                <div className="mb-4 relative">
                                    <Icon name="search" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" />
                                    <input type="text" placeholder="Search transactions..." className="w-full pl-12 p-4 bg-dark-800 border border-white/10 rounded-2xl focus:border-neon-cyan/50 focus:shadow-[0_0_15px_rgba(6,182,212,0.15)] outline-none font-semibold text-slate-200 placeholder-slate-600 shadow-sm transition-all" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                                </div>
                                <div className="space-y-3">
                                    {filteredTransactions.length === 0 ? <div className="text-center py-20 text-slate-600">No results found</div> : filteredTransactions.map(t => (
                                        <div key={t.id} className="glass-card p-4 rounded-3xl flex justify-between items-center shadow-sm hover:bg-white/5 transition-colors">
                                            <div className="flex items-center gap-4">
                                                <div className={`p-3 rounded-2xl ${t.type==='income'?'bg-emerald-500/10 text-emerald-400':t.type==='transfer'?'bg-blue-500/10 text-blue-400':'bg-white/5 text-slate-500'}`}><Icon name={t.categoryId==='system'?'rss':t.type==='income'?'arrow-down':t.type==='transfer'?'arrow-right-left':'arrow-up'} size={18}/></div>
                                                <div><p className="font-bold text-slate-200 text-sm">{t.description}</p><p className="text-xs text-slate-500">{new Date(t.date).toLocaleDateString()}</p></div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className={`font-black ${t.type==='income'?'text-emerald-400':t.type==='transfer'?'text-blue-400':'text-slate-100'}`}>{t.type==='income'?'+':t.type==='transfer'?'':'-'}${parseFloat(t.amount).toFixed(2)}</span>
                                                <button onClick={() => { if(confirm('Delete transaction? (Balances revert)')) handleDeleteTransaction(t.id) }} className="text-rose-400 hover:text-rose-300 p-2 opacity-50 hover:opacity-100 transition-opacity"><Icon name="trash-2" size={16} /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* ADD CATEGORY MODAL */}
                    {showAddCat && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-enter">
                            <div className="bg-dark-900 border border-white/10 rounded-[2rem] p-6 w-full max-w-sm shadow-2xl">
                                <h2 className="text-xl font-black mb-4 text-white">New Category</h2>
                                <div className="space-y-4">
                                    <input type="text" placeholder="Name (e.g. Pets)" className="w-full p-3 bg-dark-800 border border-white/10 rounded-xl font-bold text-white focus:border-neon-purple outline-none" value={newCatForm.name} onChange={e => setNewCatForm({...newCatForm, name: e.target.value})} />
                                    <input type="number" placeholder="Weekly Limit ($)" className="w-full p-3 bg-dark-800 border border-white/10 rounded-xl font-bold text-white focus:border-neon-purple outline-none" value={newCatForm.limit} onChange={e => setNewCatForm({...newCatForm, limit: e.target.value})} />
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Icon</label>
                                        <div className="grid grid-cols-4 gap-2">
                                            {AVAILABLE_ICONS.map(ic => (
                                                <button key={ic} onClick={() => setNewCatForm({...newCatForm, icon: ic})} className={`p-3 rounded-xl flex justify-center transition-all ${newCatForm.icon === ic ? 'bg-neon-purple text-white shadow-[0_0_15px_rgba(168,85,247,0.4)]' : 'bg-white/5 text-slate-500 hover:bg-white/10'}`}><Icon name={ic} size={20}/></button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => setShowAddCat(false)} className="flex-1 py-3 text-slate-500 font-bold hover:bg-white/10 rounded-xl transition-colors">Cancel</button>
                                        <button onClick={handleCreateCategory} disabled={!newCatForm.name || !newCatForm.limit} className="flex-1 py-3 bg-neon-purple hover:bg-purple-500 text-white rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:bg-slate-800 transition-all">Create</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showWeekModal && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-enter">
                            <div className="bg-dark-900 border border-white/10 rounded-[2rem] p-8 w-full max-w-sm shadow-2xl">
                                <h2 className="text-2xl font-black mb-3 text-white">Next Cycle?</h2>
                                <p className="text-slate-400 mb-8 font-medium">This adds budget to your envelopes. Unspent money and debts roll over.</p>
                                <div className="bg-indigo-500/10 p-5 rounded-2xl mb-8 flex gap-4 items-center border border-indigo-500/20">
                                    <input type="checkbox" className="w-6 h-6 rounded-lg text-neon-purple bg-dark-800 border-white/20 focus:ring-offset-0 focus:ring-0" checked={isNewMonth} onChange={e => setIsNewMonth(e.target.checked)} />
                                    <span className="font-bold text-indigo-200 text-sm">New Month? <span className="font-normal text-indigo-300/50 block text-xs mt-0.5">Refills Rent/Phone</span></span>
                                </div>
                                <div className="flex gap-4"><button onClick={() => setShowWeekModal(false)} className="flex-1 py-4 font-bold text-slate-500 bg-dark-800 rounded-2xl hover:bg-white/5 transition-colors">Cancel</button><button onClick={handleWeekReset} className="flex-1 py-4 font-bold text-white bg-neon-purple rounded-2xl shadow-xl hover:bg-purple-500 transition-all shadow-[0_0_20px_rgba(168,85,247,0.3)]">Confirm</button></div>
                            </div>
                        </div>
                    )}

                    {showResetConfirm && (
                        <div className="fixed inset-0 bg-rose-950/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-enter">
                            <div className="bg-dark-900 border border-rose-900/30 rounded-[2rem] p-8 w-full max-w-sm shadow-2xl text-center">
                                <div className="text-rose-500 mb-6 flex justify-center"><Icon name="alert-circle" size={48} /></div>
                                <h2 className="text-2xl font-black mb-2 text-white">Delete All?</h2>
                                <div className="flex gap-4 mt-8"><button onClick={() => setShowResetConfirm(false)} className="flex-1 py-4 font-bold text-slate-500 bg-dark-800 rounded-2xl hover:bg-white/5">Cancel</button><button onClick={performReset} className="flex-1 py-4 font-bold text-white bg-rose-600 rounded-2xl shadow-xl hover:bg-rose-500">Delete</button></div>
                            </div>
                        </div>
                    )}

                    {/* NAV */}
                    <div className="fixed bottom-8 left-0 right-0 flex justify-center z-40 pointer-events-none">
                        <nav className="glass-nav rounded-3xl p-2 flex gap-1 sm:gap-2 pointer-events-auto transition-all shadow-2xl">
                            <button onClick={() => setView('dashboard')} className={`p-4 rounded-2xl transition-all duration-300 ${view === 'dashboard' ? 'bg-neon-purple text-white shadow-[0_0_20px_rgba(168,85,247,0.4)]' : 'text-slate-500 hover:text-slate-300 hover:bg-white/5'}`}><Icon name="layout-dashboard" /></button>
                            <button onClick={() => setView('breakdown')} className={`p-4 rounded-2xl transition-all duration-300 ${view === 'breakdown' ? 'bg-neon-cyan text-black shadow-[0_0_20px_rgba(6,182,212,0.4)]' : 'text-slate-500 hover:text-slate-300 hover:bg-white/5'}`}><Icon name="pie-chart" /></button>
                            <button onClick={() => setView('add')} className="bg-white text-black p-4 rounded-2xl shadow-[0_0_25px_rgba(255,255,255,0.3)] hover:scale-105 active:scale-95 transition-all mx-1 sm:mx-2"><Icon name="plus" size={28} strokeWidth={3} /></button>
                            <button onClick={() => setView('history')} className={`p-4 rounded-2xl transition-all duration-300 ${view === 'history' ? 'bg-neon-pink text-white shadow-[0_0_20px_rgba(236,72,153,0.4)]' : 'text-slate-500 hover:text-slate-300 hover:bg-white/5'}`}><Icon name="history" /></button>
                            <button onClick={() => setView('settings')} className={`p-4 rounded-2xl transition-all duration-300 ${view === 'settings' ? 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'text-slate-500 hover:text-slate-300 hover:bg-white/5'}`}><Icon name="settings" /></button>
                        </nav>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
