<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BudgetFlow Neon AI</title>

    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: { 100: 'rgba(255, 255, 255, 0.05)', 200: 'rgba(255, 255, 255, 0.1)', border: 'rgba(255, 255, 255, 0.1)' },
                        neon: { green: '#00ff9d', blue: '#00f0ff', red: '#ff0055', purple: '#bd00ff' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'blob': 'blob 20s infinite alternate', 'pulse-slow': 'pulse 4s infinite' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0, 0) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.2)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.8)' },
                            '100%': { transform: 'translate(0, 0) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 2. REACT (Global) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- 3. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. FIREBASE (Compat Mode - STABLE) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- 6. FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #root {
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 10;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        /* Enhanced Liquid Background with Aurora */
        .liquid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(125deg, #000000 0%, #0a0014 50%, #000a0a 100%);
            pointer-events: none;
            animation: auroraShift 30s ease-in-out infinite;
        }

        @keyframes auroraShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        /* Enhanced Orbs with Depth */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: blob 20s infinite alternate;
            will-change: transform;
        }

        .orb-1 {
            top: -10%;
            left: -10%;
            width: 60vw;
            height: 60vw;
            background: radial-gradient(circle, #00ff9d 0%, #00cc7a 100%);
            mix-blend-mode: screen;
        }

        .orb-2 {
            top: 30%;
            right: -20%;
            width: 70vw;
            height: 70vw;
            background: radial-gradient(circle, #00f0ff 0%, #06b6d4 100%);
            animation-delay: -5s;
            mix-blend-mode: screen;
        }

        .orb-3 {
            bottom: -10%;
            left: 20%;
            width: 80vw;
            height: 80vw;
            background: radial-gradient(circle, #ff0055 0%, #bd00ff 100%);
            animation-delay: -10s;
            mix-blend-mode: screen;
        }

        /* Particle Effect */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) translateX(0px);
                opacity: 0.3;
            }

            50% {
                transform: translateY(-30px) translateX(10px);
                opacity: 0.6;
            }
        }

        /* Glassmorphism 2.0 */
        .glass-card {
            background: rgba(20, 20, 20, 0.5);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow:
                0 8px 32px 0 rgba(0, 0, 0, 0.4),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.03),
                    transparent);
            transition: left 0.5s;
        }

        .glass-card:hover::before {
            left: 100%;
        }

        .glass-nav {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow:
                0 -4px 24px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        /* Enhanced Inputs */
        input,
        select {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input:focus,
        select:focus {
            border-color: #00ff9d;
            box-shadow:
                0 0 20px rgba(0, 255, 157, 0.25),
                0 0 40px rgba(0, 255, 157, 0.1);
            outline: none;
            background: rgba(0, 0, 0, 0.6);
            transform: translateY(-1px);
        }

        /* Advanced Animations */
        .animate-enter {
            animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes slideUpFade {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Stagger Delays */
        .stagger-1 {
            animation-delay: 0.05s;
        }

        .stagger-2 {
            animation-delay: 0.1s;
        }

        .stagger-3 {
            animation-delay: 0.15s;
        }

        .stagger-4 {
            animation-delay: 0.2s;
        }

        /* Spring Bounce Effect */
        .tap-feedback:active {
            animation: springBounce 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes springBounce {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.92);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Shimmer Loading */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .shimmer {
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.1) 50%,
                    rgba(255, 255, 255, 0) 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* Pulse Glow */
        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 10px currentColor;
                opacity: 1;
            }

            50% {
                box-shadow: 0 0 20px currentColor;
                opacity: 0.8;
            }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        /* Number Counter Animation */
        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ripple Effect */
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Smooth Page Transition */
        @keyframes pageFadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Enhanced Blob Animation */
        @keyframes blob {

            0%,
            100% {
                transform: translate(0px, 0px) scale(1);
            }

            33% {
                transform: translate(30px, -50px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }
        }

        /* Glow Text */
        .text-glow {
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
        }

        /* Gradient Animations */
        @keyframes gradientRotate {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .gradient-animate {
            background-size: 200% 200%;
            animation: gradientRotate 3s ease infinite;
        }

        /* Success Confetti */
        @keyframes confetti {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Scale Pop Enhanced */
        @keyframes scalePop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.95);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Bounce In Spring */
        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px currentColor;
            }

            50% {
                box-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
            }
        }

        .animate-bounce-in {
            animation: bounceIn 0.4s ease-out forwards;
        }

        .animate-scale-pop {
            animation: scalePop 0.2s ease-out;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        .shimmer-bg {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        .stagger-1 {
            animation-delay: 0.1s;
        }

        .stagger-2 {
            animation-delay: 0.2s;
        }

        .stagger-3 {
            animation-delay: 0.3s;
        }

        .stagger-4 {
            animation-delay: 0.4s;
        }

        .tap-feedback:active {
            transform: scale(0.97);
            opacity: 0.8;
        }

        .progress-striped {
            background-image: linear-gradient(45deg, rgba(255, 255, 255, .1) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .1) 50%, rgba(255, 255, 255, .1) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
        }

        #loading-screen {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ff9d;
            font-weight: bold;
            background: black;
            transition: opacity 0.5s;
            flex-direction: column;
            gap: 10px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 255, 157, 0.95);
            color: black;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 14px;
            z-index: 100;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 40px rgba(0, 255, 157, 0.3);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: rgba(255, 0, 85, 0.95);
            color: white;
            box-shadow: 0 10px 40px rgba(255, 0, 85, 0.3);
        }

        /* Confetti Container */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 200;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100%) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Floating Action Button Pulse */
        .fab-pulse {
            animation: fabPulse 2s ease-in-out infinite;
        }

        @keyframes fabPulse {

            0%,
            100% {
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.4);
            }

            50% {
                box-shadow: 0 0 50px rgba(255, 255, 255, 0.6), 0 0 80px rgba(255, 255, 255, 0.3);
            }
        }

        /* Empty State Animation */
        @keyframes emptyFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .empty-float {
            animation: emptyFloat 3s ease-in-out infinite;
        }

        /* Print Styles */
        @media print {

            .liquid-bg,
            .glass-nav,
            .no-print {
                display: none !important;
            }

            body,
            #root {
                background: white !important;
                color: black !important;
                height: auto !important;
                overflow: visible !important;
            }

            .glass-card {
                background: none !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
                color: black !important;
                page-break-inside: avoid;
            }

            .text-white {
                color: black !important;
            }

            .text-slate-500,
            .text-slate-400 {
                color: #666 !important;
            }
        }
    </style>
</head>

<body>
    <div id="loading-screen">
        <div style="font-size: 2rem;">ðŸš€</div>
        <div>Starting System...</div>
    </div>

    <div class="liquid-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <div id="root"></div>

    <!-- MAIN SCRIPT -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ðŸŸ¢ FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCY0D823ZoNP8t5A0LSTk2eZrLiQKVr0XI",
            authDomain: "my-budget-tracker-64883.firebaseapp.com",
            projectId: "my-budget-tracker-64883",
            storageBucket: "my-budget-tracker-64883.firebasestorage.app",
            messagingSenderId: "502096393014",
            appId: "1:502096393014:web:69df0d5bdbba7efd2f3997"
        };

        // --- Init Services (Compat Mode) ---
        let db, auth;
        const APP_ID = 'budget-tracker-personal';

        try {
            if (window.firebase) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
            } else {
                console.error("Firebase script not loaded");
            }
        } catch (e) {
            console.warn("Firebase Init Error:", e);
        }

        const AVAILABLE_ICONS = ['apple', 'shopping-bag', 'home', 'smartphone', 'coffee', 'car', 'dumbbell', 'heart', 'gift', 'plane', 'book', 'briefcase', 'gamepad-2', 'paw-print', 'graduation-cap', 'utensils', 'zap', 'droplet'];
        const INITIAL_CATEGORIES = [
            { id: '1', name: 'Grocery', limit: 70, balance: 70, icon: 'apple', frequency: 'weekly', color: 'text-neon-green' },
            { id: '2', name: 'Shopping', limit: 65, balance: 65, icon: 'shopping-bag', frequency: 'weekly', color: 'text-neon-blue' },
            { id: '3', name: 'Rent', limit: 700, balance: 700, icon: 'home', frequency: 'monthly', color: 'text-neon-purple' },
            { id: '4', name: 'Phone', limit: 65, balance: 65, icon: 'smartphone', frequency: 'monthly', color: 'text-neon-red' },
        ];

        // Safe Icon Component
        const Icon = ({ name, size = 24, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // Markdown Formatter for AI
        const MarkdownText = ({ text }) => {
            if (!text) return null;
            const html = text
                .replace(/\*\*(.*?)\*\*/g, '<b class="text-neon-green">$1</b>')
                .replace(/\n/g, '<br/>');
            return <div dangerouslySetInnerHTML={{ __html: html }} />;
        };

        function App() {
            // --- STATE ---
            const [user, setUser] = useState(null);
            const [isOffline, setIsOffline] = useState(true);
            const [categories, setCategories] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [weeksTracked, setWeeksTracked] = useState(1);

            const [view, setView] = useState('dashboard');
            const [newTransaction, setNewTransaction] = useState({ categoryId: '', amount: '', description: '', type: 'expense' });
            const [transferData, setTransferData] = useState({ fromId: '', toId: '', amount: '' });

            const [showWeekModal, setShowWeekModal] = useState(false);
            const [isNewMonth, setIsNewMonth] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);

            const [editingCategory, setEditingCategory] = useState(null);
            const [editLimitValue, setEditLimitValue] = useState('');
            const [showAddCat, setShowAddCat] = useState(false);
            const [newCatForm, setNewCatForm] = useState({ name: '', limit: '', icon: 'shopping-bag', frequency: 'weekly' });
            const [editForm, setEditForm] = useState({ name: '', limit: '', balance: '', icon: '' });

            const [geminiKey, setGeminiKey] = useState(() => localStorage.getItem('gemini_key') || '');
            const [aiModel, setAiModel] = useState(() => localStorage.getItem('ai_model') || 'gemini-1.5-flash');
            const [chatHistory, setChatHistory] = useState([{ role: 'model', text: "Hi! I'm Gemini. I can analyze spending and track receipts! ðŸ“Š" }]);
            const [chatInput, setChatInput] = useState('');
            const [isThinking, setIsThinking] = useState(false);
            const [magicText, setMagicText] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [showTuneUp, setShowTuneUp] = useState(false);
            const [tuneUpProposals, setTuneUpProposals] = useState(null);
            const [reportCard, setReportCard] = useState(null);
            const [isListening, setIsListening] = useState(false);

            const [now, setNow] = useState(new Date());
            const chatEndRef = useRef(null);
            const fileInputRef = useRef(null);
            const receiptInputRef = useRef(null);

            // Analytics State
            const [analyticsView, setAnalyticsView] = useState('overview'); // overview, category, compare
            const [selectedMonth, setSelectedMonth] = useState(new Date());
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [chartRange, setChartRange] = useState(7); // 7, 14, 30 days
            const [compareMonth, setCompareMonth] = useState(() => {
                const d = new Date();
                d.setMonth(d.getMonth() - 1);
                return d;
            });

            // --- INIT ---
            useEffect(() => {
                const loader = document.getElementById('loading-screen');
                if (loader) { setTimeout(() => { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }, 800); }
                if (!auth) {
                    setIsOffline(true);
                    setCategories(INITIAL_CATEGORIES);
                } else {
                    auth.onAuthStateChanged(u => {
                        if (u) { setUser(u); setIsOffline(false); }
                        else { auth.signInAnonymously().catch((e) => { console.error("Auth Fail:", e); setIsOffline(true); }); }
                    });
                }
            }, []);
            useEffect(() => { const t = setInterval(() => setNow(new Date()), 60000); return () => clearInterval(t); }, []);

            useEffect(() => {
                if (view === 'ai' && chatEndRef.current) {
                    chatEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            }, [chatHistory, view, isThinking, reportCard]);

            // --- DATA SYNC ---
            useEffect(() => {
                if (isOffline || !user) {
                    try {
                        const c = JSON.parse(localStorage.getItem('cats_v33') || JSON.stringify(INITIAL_CATEGORIES));
                        const t = JSON.parse(localStorage.getItem('tx_v33') || '[]');
                        const w = parseInt(localStorage.getItem('meta_v33') || '1');
                        if (c) setCategories(c); if (t) setTransactions(t); if (w) setWeeksTracked(w);
                    } catch (e) { setCategories(INITIAL_CATEGORIES); }
                    return;
                }
                const unsubC = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').onSnapshot(s => {
                    const d = s.docs.map(x => x.data());
                    if (d.length) setCategories(d.sort((a, b) => a.id.localeCompare(b.id))); else checkMigration();
                }, () => setIsOffline(true));
                const unsubT = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions').onSnapshot(s => {
                    setTransactions(s.docs.map(x => x.data()).sort((a, b) => new Date(b.date) - new Date(a.date)));
                });
                const unsubM = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('meta').doc('weeks').onSnapshot(s => {
                    if (s.exists) setWeeksTracked(s.data().count);
                });
                return () => { unsubC(); unsubT(); unsubM(); };
            }, [user, isOffline]);

            const checkMigration = async () => {
                const b = db.batch();
                INITIAL_CATEGORIES.forEach(c => b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(c.id), c));
                b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('meta').doc('weeks'), { count: 1 });
                await b.commit();
            };
            const saveLocal = (c, t, w) => {
                setCategories(c); setTransactions(t); setWeeksTracked(w);
                localStorage.setItem('cats_v33', JSON.stringify(c)); localStorage.setItem('tx_v33', JSON.stringify(t)); localStorage.setItem('meta_v33', w.toString());
            };

            // --- AI & LOGIC ---
            const callGemini = async (prompt, b64) => {
                if (!geminiKey) throw new Error("Missing API Key. Go to Settings.");
                const body = { contents: [{ parts: [{ text: prompt }] }] };
                if (b64) body.contents[0].parts.push({ inline_data: { mime_type: "image/jpeg", data: b64 } });

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${aiModel}:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.status === 429) throw new Error("Rate limit exceeded. Try a different model in Settings.");

                const d = await res.json();
                if (d.error) throw new Error(d.error.message);
                return d.candidates?.[0]?.content?.parts?.[0]?.text;
            };

            const cleanJson = (text) => {
                if (!text) return "";
                return text.replace(/```json/g, "").replace(/```/g, "").trim();
            };

            const handleSendMessage = async (e, prompt) => {
                if (e) e.preventDefault(); const t = prompt || chatInput; if (!t.trim()) return;
                setChatInput(''); setView('ai');
                if (!prompt) setChatHistory(p => [...p, { role: 'user', text: t }]);
                setIsThinking(true);
                setReportCard(null);
                try {
                    const c = JSON.stringify({ cats: categories, tx: transactions.slice(0, 30) });
                    const r = await callGemini(`Context: ${c}. User: ${t}. concise, helpful, markdown.`);
                    setChatHistory(p => [...p, { role: 'model', text: r }]);
                } catch (e) { setChatHistory(p => [...p, { role: 'model', text: `Error: ${e.message}` }]); }
                setIsThinking(false);
            };

            const handleMagic = async () => {
                if (!magicText) return; setIsThinking(true);
                try {
                    const r = await callGemini(`Extract JSON {amount, description, categoryId} from "${magicText}". IDs: ${JSON.stringify(categories.map(c => ({ id: c.id, name: c.name })))}`);
                    const d = JSON.parse(cleanJson(r));
                    if (d.amount) setNewTransaction({ ...newTransaction, amount: d.amount, description: d.description, categoryId: d.categoryId || categories[0].id });
                } catch (e) { alert("Failed to parse"); } setIsThinking(false); setMagicText('');
            };

            const handleVoiceInput = () => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert("Voice not supported on this browser."); return;
                }
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.interimResults = false;

                setIsListening(true);
                recognition.start();

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setMagicText(transcript);
                    setIsListening(false);
                    setTimeout(() => handleMagic(), 1000);
                };

                recognition.onerror = (e) => { setIsListening(false); };
                recognition.onend = () => setIsListening(false);
            };

            const handleScan = (e) => {
                const f = e.target.files[0]; if (!f) return; const r = new FileReader();
                r.onload = async (ev) => { setIsThinking(true); try { const b64 = ev.target.result.split(',')[1]; const r = await callGemini(`Scan receipt. JSON {amount, description, categoryId}. IDs: ${JSON.stringify(categories.map(c => ({ id: c.id, name: c.name })))}`, b64); const d = JSON.parse(cleanJson(r)); setNewTransaction({ ...newTransaction, amount: d.amount, description: d.description, categoryId: d.categoryId || categories[0].id }); } catch (e) { alert("Scan Error"); } setIsThinking(false); }; r.readAsDataURL(f);
            };

            const handleTuneUp = async () => { setIsThinking(true); setShowTuneUp(true); try { const r = await callGemini(`Audit spending. JSON [{"id","newLimit","reason"}]. Context: ${JSON.stringify({ cats: categories, tx: transactions.slice(0, 50) })}`); setTuneUpProposals(JSON.parse(cleanJson(r))); } catch (e) { alert("Audit Failed"); setShowTuneUp(false); } setIsThinking(false); };

            const handleReportCard = async () => {
                if (!geminiKey) { alert("Please enter your Gemini API Key in Settings first."); setView('settings'); return; }
                setView('ai');
                setIsThinking(true);
                setReportCard(null);
                try {
                    const ctx = JSON.stringify({ cats: categories, tx: transactions.filter(t => new Date(t.date).getMonth() === now.getMonth()) });
                    const p = `Generate a 'Monthly Report Card'. Grade (A-F). List 3 Wins, 3 Leaks, and 1 Strategy. Use bold for headers. Context: ${ctx}`;
                    const r = await callGemini(p);
                    setReportCard(r);
                } catch (e) { setReportCard("Error generating report: " + e.message); }
                setIsThinking(false);
            };

            // --- Toast & Confetti Helpers ---
            const [toast, setToast] = useState({ show: false, message: '', error: false });
            const [showConfetti, setShowConfetti] = useState(false);

            const showToast = (message, error = false) => {
                setToast({ show: true, message, error });
                setTimeout(() => setToast({ show: false, message: '', error: false }), 3000);
            };

            const triggerConfetti = () => {
                setShowConfetti(true);
                setTimeout(() => setShowConfetti(false), 3000);
            };

            // --- CRUD ---
            const handleAdd = async (e) => {
                e.preventDefault(); const c = categories.find(x => x.id === newTransaction.categoryId); if (!c) return;
                const amt = parseFloat(newTransaction.amount); const isExp = (newTransaction.type || 'expense') === 'expense'; const bal = isExp ? c.balance - amt : c.balance + amt;
                const tx = { id: Date.now().toString(), date: new Date().toISOString(), amount: amt, description: newTransaction.description || (isExp ? 'Expense' : 'Income'), categoryId: c.id, categoryName: c.name, type: isExp ? 'expense' : 'income' };
                const nc = categories.map(x => x.id === c.id ? { ...x, balance: bal } : x); const nt = [tx, ...transactions];
                if (isOffline) { saveLocal(nc, nt, weeksTracked); } else { await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(c.id).set({ ...c, balance: bal }); await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions').doc(tx.id).set(tx); saveLocal(nc, nt, weeksTracked); }
                setNewTransaction({ categoryId: '', amount: '', description: '', type: 'expense' });
                triggerConfetti();
                showToast(isExp ? `$${amt.toFixed(0)} spent on ${c.name}` : `$${amt.toFixed(0)} added to ${c.name}`);
                setView('dashboard');
            };
            const handleDelete = async (id) => {
                const tx = transactions.find(t => t.id === id); if (!tx) return; const cat = categories.find(c => c.id === tx.categoryId); let bal = 0; if (cat && tx.type !== 'transfer') bal = (tx.type !== 'income') ? cat.balance + parseFloat(tx.amount) : cat.balance - parseFloat(tx.amount);
                const nt = transactions.filter(t => t.id !== id); let nc = categories; if (cat && tx.type !== 'transfer') nc = categories.map(c => c.id === cat.id ? { ...c, balance: bal } : c);
                if (isOffline) { saveLocal(nc, nt, weeksTracked); } else { if (cat && tx.type !== 'transfer') await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(cat.id).set({ ...cat, balance: bal }); await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions').doc(id).delete(); saveLocal(nc, nt, weeksTracked); }
            };

            const handleClone = (t) => {
                setNewTransaction({ categoryId: t.categoryId, amount: t.amount, description: t.description, type: t.type || 'expense' });
                setView('add');
            };

            const handleWeekReset = async () => {
                let nc = categories.map(c => {
                    const shouldReset = c.frequency === 'weekly' || (c.frequency === 'monthly' && isNewMonth);
                    if (!shouldReset) return c;
                    // Smart rollover: cap positive at 50% of limit, carry full negative
                    const maxRollover = c.limit * 0.5;
                    const rollover = c.balance < 0 ? c.balance : Math.min(c.balance, maxRollover);
                    const newBalance = c.limit + rollover;
                    return { ...c, balance: newBalance, lastRollover: rollover };
                });
                const nw = weeksTracked + 1;
                const rolloverSummary = nc.filter(c => c.lastRollover).map(c => `${c.name}: ${c.lastRollover >= 0 ? '+' : ''}$${c.lastRollover.toFixed(0)}`).join(', ');
                const log = { id: Date.now().toString(), date: new Date().toISOString(), amount: 0, description: `Cycle ${nw} started${rolloverSummary ? ` (Rollover: ${rolloverSummary})` : ''}`, categoryId: 'system', categoryName: 'System', type: 'system' };
                if (isOffline) { saveLocal(nc, [log, ...transactions], nw); } else { const b = db.batch(); nc.forEach(c => b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(c.id), c)); b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('meta').doc('weeks'), { count: nw }); b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions').doc(log.id), log); await b.commit(); saveLocal(nc, [log, ...transactions], nw); }
                setShowWeekModal(false); setIsNewMonth(false);
            };
            const handleTransfer = async (e) => {
                e.preventDefault(); const f = categories.find(c => c.id === transferData.fromId); const t = categories.find(c => c.id === transferData.toId); const amt = parseFloat(transferData.amount);
                if (!f || !t || isNaN(amt) || amt <= 0) return;
                const tx = { id: Date.now().toString(), date: new Date().toISOString(), amount: 0, description: `Transfer: ${f.name} -> ${t.name}`, categoryId: 'system', categoryName: 'Transfer', type: 'transfer' };
                const nc = categories.map(c => { if (c.id === f.id) return { ...c, balance: c.balance - amt }; if (c.id === t.id) return { ...c, balance: c.balance + amt }; return c; }); const nt = [tx, ...transactions];
                if (isOffline) { saveLocal(nc, nt, weeksTracked); } else { const b = db.batch(); b.update(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(f.id), { balance: f.balance - amt }); b.update(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(t.id), { balance: t.balance + amt }); b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions').doc(tx.id), tx); await b.commit(); saveLocal(nc, nt, weeksTracked); }
                setTransferData({ fromId: '', toId: '', amount: '' }); setView('dashboard');
            };

            const handleUpdateLimit = async (id) => {
                const lim = parseFloat(editLimitValue);
                if (isNaN(lim)) return;
                const nc = categories.map(c => c.id === id ? { ...c, limit: lim } : c);
                if (isOffline) { saveLocal(nc, transactions, weeksTracked); } else { await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(id).update({ limit: lim }); saveLocal(nc, transactions, weeksTracked); }
                setEditingCategory(null); setEditLimitValue('');
            };

            const handleUpdateCat = async (id) => {
                const lim = parseFloat(editForm.limit); const bal = parseFloat(editForm.balance); const nam = editForm.name; if (isNaN(lim) || isNaN(bal)) return;
                const nc = categories.map(c => c.id === id ? { ...c, limit: lim, balance: bal, name: nam } : c);
                if (isOffline) { saveLocal(nc, transactions, weeksTracked); } else { await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(id).set({ ...categories.find(c => c.id === id), limit: lim, balance: bal, name: nam }); saveLocal(nc, transactions, weeksTracked); }
                setEditingCategory(null);
            };

            const startEdit = (cat) => {
                setEditingCategory(cat.id);
                setEditForm({ limit: cat.limit, balance: cat.balance, name: cat.name, icon: cat.icon });
            };

            const handleDeleteCategory = async (id) => { if (!confirm("Delete?")) return; const nc = categories.filter(c => c.id !== id); if (isOffline) { saveLocal(nc, transactions, weeksTracked); } else { await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(id).delete(); saveLocal(nc, transactions, weeksTracked); } setEditingCategory(null); };
            const handleCreateCategory = async (e) => { e.preventDefault(); const newId = Date.now().toString(); const newCat = { id: newId, name: newCatForm.name, limit: parseFloat(newCatForm.limit) || 0, balance: parseFloat(newCatForm.limit) || 0, icon: newCatForm.icon, frequency: newCatForm.frequency, color: 'text-white' }; const nc = [...categories, newCat]; if (isOffline) { saveLocal(nc, transactions, weeksTracked); } else { await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(newId).set(newCat); saveLocal(nc, transactions, weeksTracked); } setShowAddCat(false); setNewCatForm({ name: '', limit: '', icon: 'shopping-bag', frequency: 'weekly' }); };

            const performReset = async () => { if (isOffline) { localStorage.clear(); window.location.reload(); } else { const b = db.batch(); categories.forEach(c => { const def = INITIAL_CATEGORIES.find(ic => ic.id === c.id) || c; b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(c.id), { ...def, balance: def.limit }); }); transactions.forEach(t => b.delete(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions').doc(t.id))); b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('meta').doc('weeks'), { count: 1 }); await b.commit(); setShowResetConfirm(false); setView('dashboard'); } };
            const handleBackup = () => { const b = new Blob([JSON.stringify({ categories, transactions, weeksTracked })], { type: 'application/json' }); const l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = `budget_backup_${new Date().toISOString().slice(0, 10)}.json`; document.body.appendChild(l); l.click(); document.body.removeChild(l); };
            const handleRestore = (e) => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = async (ev) => { try { const d = JSON.parse(ev.target.result); if (!d.categories) throw new Error(); if (confirm("Overwrite?")) { if (isOffline) { setCategories(d.categories); setTransactions(d.transactions); setWeeksTracked(d.weeksTracked); saveLocal(d.categories, d.transactions, d.weeksTracked); } else { const b = db.batch(); d.categories.forEach(c => b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(c.id), c)); d.transactions.forEach(t => b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions').doc(t.id), t)); b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('meta').doc('weeks'), { count: d.weeksTracked }); await b.commit(); } window.location.reload(); } } catch (err) { alert("Error"); } }; r.readAsText(f); };
            const handleExport = () => { const rows = [["Date", "Description", "Category", "Amount", "Type"], ...transactions.map(t => [new Date(t.date).toLocaleDateString(), `"${t.description.replace(/"/g, '""')}"`, t.categoryName, t.amount, t.type || 'expense'])]; const csv = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n"); const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `budget_export.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const applyTuneUp = async () => { if (!tuneUpProposals) return; const newCats = categories.map(c => { const p = tuneUpProposals.find(p => p.id === c.id); return p ? { ...c, limit: p.newLimit } : c; }); if (isOffline) { setCategories(newCats); saveLocal(newCats, transactions, weeksTracked); } else { const b = db.batch(); newCats.forEach(c => b.set(db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('categories').doc(c.id), c)); await b.commit(); saveLocal(newCats, transactions, weeksTracked); } setShowTuneUp(false); setTuneUpProposals(null); alert("Updated!"); };

            const handlePrint = () => { window.print(); };

            // Stats & Calendar
            const totalFunds = categories.reduce((s, c) => s + c.balance, 0);

            const calendarData = useMemo(() => {
                const d = new Date(now);
                const currentDay = d.getDate();
                const dayOfWeek = d.getDay();
                const startDiff = d.getDate() - dayOfWeek;
                const startOfWeek = new Date(d);
                startOfWeek.setDate(startDiff);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                const fmt = (date) => date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                return {
                    day: currentDay,
                    week: Math.ceil(currentDay / 7),
                    month: now.toLocaleString('default', { month: 'short' }),
                    range: `${fmt(startOfWeek)} - ${fmt(endOfWeek)}`
                };
            }, [now]);

            const weeklyTrend = useMemo(() => { const days = []; for (let i = 6; i >= 0; i--) { const d = new Date(now); d.setDate(now.getDate() - i); days.push({ date: d, label: d.toLocaleDateString('en-US', { weekday: 'short' }), total: 0 }); } transactions.forEach(t => { if (!t.date || t.categoryId === 'system' || t.type === 'income' || t.type === 'transfer') return; const td = new Date(t.date); const ds = days.find(d => d.date.getDate() === td.getDate() && d.date.getMonth() === td.getMonth()); if (ds) ds.total += parseFloat(t.amount); }); const max = Math.max(...days.map(d => d.total), 1); return days.map(d => ({ ...d, pct: max === 0 ? 0 : (d.total / max) * 100 })); }, [transactions, now]);
            const monthlyBreakdown = useMemo(() => { const groups = {}; transactions.forEach(t => { if (!t.date || t.categoryId === 'system' || t.type === 'income' || t.type === 'transfer') return; const d = new Date(t.date); const k = `${d.toLocaleString('default', { month: 'long' })} ${d.getFullYear()}`; if (!groups[k]) groups[k] = { total: 0, cats: {} }; groups[k].total += parseFloat(t.amount); if (!groups[k].cats[t.categoryName]) groups[k].cats[t.categoryName] = 0; groups[k].cats[t.categoryName] += parseFloat(t.amount); }); return Object.entries(groups).sort((a, b) => new Date(b[0]) - new Date(a[0])); }, [transactions]);
            const monthlyTotal = transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === now.getMonth() && t.categoryId !== 'system' && t.type !== 'income' && t.type !== 'transfer'; }).reduce((sum, t) => sum + parseFloat(t.amount), 0);

            // Spending Velocity Calculation
            const dailyAvg = monthlyTotal / Math.max(now.getDate(), 1);
            const monthlyLimit = categories.reduce((s, c) => s + (c.frequency === 'monthly' ? c.limit : c.limit * 4), 0);
            const targetDaily = monthlyLimit / 30;
            const velocityColor = dailyAvg > targetDaily ? 'text-neon-red' : 'text-neon-green';
            const velocityIcon = dailyAvg > targetDaily ? 'trending-up' : 'trending-down';

            // Budget Health Score (A-F)
            const totalSpentRatio = monthlyLimit > 0 ? monthlyTotal / (monthlyLimit * (now.getDate() / 30)) : 0;
            const getHealthGrade = (ratio) => {
                if (ratio <= 0.7) return { grade: 'A', color: 'text-neon-green', bg: 'bg-neon-green' };
                if (ratio <= 0.9) return { grade: 'B', color: 'text-neon-blue', bg: 'bg-neon-blue' };
                if (ratio <= 1.0) return { grade: 'C', color: 'text-yellow-400', bg: 'bg-yellow-400' };
                if (ratio <= 1.2) return { grade: 'D', color: 'text-orange-500', bg: 'bg-orange-500' };
                return { grade: 'F', color: 'text-neon-red', bg: 'bg-neon-red' };
            };
            const healthScore = getHealthGrade(totalSpentRatio);

            // Days until next cycle (Sunday reset)
            const daysUntilSunday = (7 - now.getDay()) % 7 || 7;
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const daysLeftInMonth = daysInMonth - now.getDate();

            // Category spending breakdown for pie chart
            const categorySpending = useMemo(() => {
                const spending = {};
                transactions.forEach(t => {
                    if (!t.date || t.categoryId === 'system' || t.type === 'income' || t.type === 'transfer') return;
                    const d = new Date(t.date);
                    if (d.getMonth() !== selectedMonth.getMonth() || d.getFullYear() !== selectedMonth.getFullYear()) return;
                    if (!spending[t.categoryName]) spending[t.categoryName] = { amount: 0, color: categories.find(c => c.name === t.categoryName)?.color || 'text-white', icon: categories.find(c => c.name === t.categoryName)?.icon || 'circle' };
                    spending[t.categoryName].amount += parseFloat(t.amount);
                });
                const total = Object.values(spending).reduce((s, v) => s + v.amount, 0);
                return Object.entries(spending).map(([name, data]) => ({
                    name,
                    amount: data.amount,
                    percentage: total > 0 ? (data.amount / total) * 100 : 0,
                    color: data.color,
                    icon: data.icon
                })).sort((a, b) => b.amount - a.amount);
            }, [transactions, categories, selectedMonth]);

            // Daily spending data for bar chart
            const dailySpendingData = useMemo(() => {
                const days = [];
                for (let i = chartRange - 1; i >= 0; i--) {
                    const d = new Date(now);
                    d.setDate(now.getDate() - i);
                    days.push({
                        date: d,
                        label: d.toLocaleDateString('en-US', { weekday: 'short' }),
                        dayNum: d.getDate(),
                        total: 0,
                        transactions: []
                    });
                }
                transactions.forEach(t => {
                    if (!t.date || t.categoryId === 'system' || t.type === 'income' || t.type === 'transfer') return;
                    const td = new Date(t.date);
                    const ds = days.find(d => d.date.getDate() === td.getDate() && d.date.getMonth() === td.getMonth() && d.date.getFullYear() === td.getFullYear());
                    if (ds) {
                        ds.total += parseFloat(t.amount);
                        ds.transactions.push(t);
                    }
                });
                const max = Math.max(...days.map(d => d.total), 1);
                const avg = days.reduce((s, d) => s + d.total, 0) / days.length;
                return { days: days.map(d => ({ ...d, pct: max === 0 ? 0 : (d.total / max) * 100, isAboveAvg: d.total > avg })), max, avg };
            }, [transactions, now, chartRange]);

            // Month-over-month comparison
            const monthComparison = useMemo(() => {
                const getMonthData = (month) => {
                    const spending = {};
                    let total = 0;
                    transactions.forEach(t => {
                        if (!t.date || t.categoryId === 'system' || t.type === 'income' || t.type === 'transfer') return;
                        const d = new Date(t.date);
                        if (d.getMonth() !== month.getMonth() || d.getFullYear() !== month.getFullYear()) return;
                        total += parseFloat(t.amount);
                        if (!spending[t.categoryName]) spending[t.categoryName] = 0;
                        spending[t.categoryName] += parseFloat(t.amount);
                    });
                    return { spending, total };
                };

                const current = getMonthData(selectedMonth);
                const previous = getMonthData(compareMonth);

                const allCategories = [...new Set([...Object.keys(current.spending), ...Object.keys(previous.spending)])];
                const comparison = allCategories.map(cat => ({
                    name: cat,
                    current: current.spending[cat] || 0,
                    previous: previous.spending[cat] || 0,
                    change: previous.spending[cat] ? ((current.spending[cat] || 0) - previous.spending[cat]) / previous.spending[cat] * 100 : 100,
                    icon: categories.find(c => c.name === cat)?.icon || 'circle'
                })).sort((a, b) => b.current - a.current);

                return {
                    currentTotal: current.total,
                    previousTotal: previous.total,
                    totalChange: previous.total ? (current.total - previous.total) / previous.total * 100 : 0,
                    categories: comparison
                };
            }, [transactions, selectedMonth, compareMonth, categories]);

            // Spending insights
            const spendingInsights = useMemo(() => {
                const insights = [];
                const topCategory = categorySpending[0];
                if (topCategory) {
                    insights.push({
                        type: 'top',
                        icon: 'trending-up',
                        color: 'text-neon-red',
                        text: `${topCategory.name} is your top category at $${topCategory.amount.toFixed(0)} (${topCategory.percentage.toFixed(0)}%)`
                    });
                }

                // Find highest spending day
                const highestDay = dailySpendingData.days.reduce((max, d) => d.total > max.total ? d : max, dailySpendingData.days[0]);
                if (highestDay && highestDay.total > 0) {
                    insights.push({
                        type: 'peak',
                        icon: 'alert-triangle',
                        color: 'text-yellow-400',
                        text: `Peak spending: ${highestDay.label} at $${highestDay.total.toFixed(0)}`
                    });
                }

                // Budget projection
                const daysElapsed = now.getDate();
                const projectedMonthly = (monthlyTotal / daysElapsed) * daysInMonth;
                if (projectedMonthly > monthlyLimit) {
                    insights.push({
                        type: 'warning',
                        icon: 'alert-circle',
                        color: 'text-neon-red',
                        text: `At this pace, you'll spend $${projectedMonthly.toFixed(0)} this month (over by $${(projectedMonthly - monthlyLimit).toFixed(0)})`
                    });
                } else {
                    insights.push({
                        type: 'good',
                        icon: 'check-circle',
                        color: 'text-neon-green',
                        text: `On track to save $${(monthlyLimit - projectedMonthly).toFixed(0)} this month`
                    });
                }

                return insights;
            }, [categorySpending, dailySpendingData, monthlyTotal, monthlyLimit, daysInMonth, now]);

            // Total for selected month
            const selectedMonthTotal = useMemo(() => {
                return transactions.filter(t => {
                    if (!t.date || t.categoryId === 'system' || t.type === 'income' || t.type === 'transfer') return false;
                    const d = new Date(t.date);
                    return d.getMonth() === selectedMonth.getMonth() && d.getFullYear() === selectedMonth.getFullYear();
                }).reduce((s, t) => s + parseFloat(t.amount), 0);
            }, [transactions, selectedMonth]);

            // Suggested daily budget
            const suggestedDaily = daysLeftInMonth > 0 ? totalFunds / daysLeftInMonth : 0;

            const filteredTx = transactions.filter(t => t.description.toLowerCase().includes(searchQuery.toLowerCase()) || t.categoryName.toLowerCase().includes(searchQuery.toLowerCase()));

            return (
                <div className="pb-32 max-w-md mx-auto min-h-screen relative z-10">
                    <div className="sticky top-0 glass-nav p-4 flex justify-between items-center z-50 rounded-b-3xl mx-2 mt-2 border-b border-glass-100 no-print">
                        <div className="flex items-center gap-2.5 font-bold tracking-tight">
                            <div className="bg-gradient-to-tr from-neon-green to-neon-blue text-black p-2 rounded-xl shadow-[0_0_15px_rgba(0,255,157,0.5)]"><Icon name="wallet" size={20} /></div>
                            <span className="text-lg text-white font-bold tracking-wide">BudgetFlow</span>
                        </div>
                        <button onClick={() => setShowWeekModal(true)} className="glass-card text-xs font-bold px-4 py-2 rounded-full flex items-center gap-2 text-slate-300 hover:bg-glass-200 border border-glass-100">
                            Cycle {weeksTracked} <Icon name="chevron-right" size={14} className="opacity-50" />
                        </button>
                    </div>

                    <div className="p-5 space-y-6">
                        {/* DASHBOARD */}
                        {view === 'dashboard' && (
                            <div className="animate-enter space-y-6">
                                <div className="glass-card p-8 rounded-[2.5rem] relative overflow-hidden group">
                                    <div className="absolute -top-20 -right-20 p-8 opacity-[0.1] text-neon-blue animate-pulse-slow"><Icon name="credit-card" size={250} /></div>
                                    <div className="relative z-10">
                                        <div className="flex justify-between items-start mb-2">
                                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest flex items-center gap-2"><Icon name="shield-check" size={12} className={totalFunds < 0 ? "text-neon-red" : "text-neon-green"} /> Total Balance</p>
                                            <div className={`px-3 py-1 rounded-full text-xs font-black ${healthScore.bg} text-black flex items-center gap-1`}>
                                                <Icon name="award" size={12} /> {healthScore.grade}
                                            </div>
                                        </div>
                                        <h2 className="text-6xl font-black mb-6 tracking-tighter text-white">${totalFunds.toFixed(0)}</h2>
                                        <div className="grid grid-cols-3 gap-2">
                                            <div className="bg-glass-100 backdrop-blur-xl px-3 py-3 rounded-2xl border border-glass-100 hover:bg-glass-200 transition-colors">
                                                <span className="text-[10px] text-neon-blue font-bold uppercase tracking-wider flex items-center gap-1"><Icon name="timer" size={10} /> Reset In</span>
                                                <span className="text-sm font-bold text-white mt-1 block">{daysUntilSunday}d</span>
                                            </div>
                                            <div className="bg-glass-100 backdrop-blur-xl px-3 py-3 rounded-2xl border border-glass-100 hover:bg-glass-200 transition-colors">
                                                <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider flex items-center gap-1">Daily Avg</span>
                                                <span className={`text-sm font-bold mt-1 flex items-center gap-1 ${velocityColor}`}>
                                                    ${dailyAvg.toFixed(0)} <Icon name={velocityIcon} size={10} />
                                                </span>
                                            </div>
                                            <div className="bg-glass-100 backdrop-blur-xl px-3 py-3 rounded-2xl border border-glass-100 hover:bg-glass-200 transition-colors">
                                                <span className="text-[10px] text-neon-green font-bold uppercase tracking-wider flex items-center gap-1"><Icon name="target" size={10} /> Target</span>
                                                <span className="text-sm font-bold text-white mt-1 block">${suggestedDaily.toFixed(0)}/d</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    {categories.map((cat, idx) => {
                                        const pct = Math.min(100, Math.max(0, (cat.balance / cat.limit) * 100));
                                        const spent = cat.limit - cat.balance;
                                        const isLow = cat.balance < 0;
                                        const isWarning = pct < 30 && pct > 0;
                                        const ringColor = isLow ? 'stroke-neon-red' : isWarning ? 'stroke-yellow-400' : 'stroke-neon-green';
                                        const circumference = 2 * Math.PI * 20;
                                        const strokeDashoffset = circumference - (pct / 100) * circumference;
                                        return (
                                            <div key={cat.id}
                                                className={`glass-card p-5 rounded-3xl transition-all duration-300 tap-feedback animate-enter stagger-${idx % 4 + 1} ${isLow ? 'border-neon-red/30 shadow-[0_0_30px_rgba(255,0,85,0.1)]' : isWarning ? 'border-yellow-400/20' : 'hover:border-white/20 hover:scale-[1.01]'}`}
                                            >
                                                <div className="flex justify-between items-center">
                                                    <div className="flex items-center gap-4">
                                                        <div className="relative">
                                                            <svg className="w-14 h-14 -rotate-90" viewBox="0 0 48 48">
                                                                <circle cx="24" cy="24" r="20" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="4" />
                                                                <circle cx="24" cy="24" r="20" fill="none" className={ringColor} strokeWidth="4" strokeLinecap="round"
                                                                    style={{ strokeDasharray: circumference, strokeDashoffset: isLow ? 0 : strokeDashoffset, transition: 'stroke-dashoffset 1s ease-out' }} />
                                                            </svg>
                                                            <div className={`absolute inset-0 flex items-center justify-center ${cat.color}`}>
                                                                <Icon name={cat.icon} size={18} />
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <h3 className="font-bold text-white text-lg tracking-tight">{cat.name}</h3>
                                                            <p className="text-xs text-slate-500 font-medium">
                                                                <span className={isLow ? 'text-neon-red' : 'text-slate-400'}>${spent.toFixed(0)}</span>
                                                                <span className="text-slate-600"> / ${cat.limit}</span>
                                                                <span className="text-slate-600 ml-1">â€¢ {cat.frequency}</span>
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <button
                                                            onClick={() => { setNewTransaction({ ...newTransaction, categoryId: cat.id, type: 'expense' }); setView('add'); }}
                                                            className="p-2.5 rounded-xl bg-glass-100 hover:bg-neon-red/20 text-slate-400 hover:text-neon-red transition-all border border-glass-200 tap-feedback"
                                                        >
                                                            <Icon name="minus" size={16} />
                                                        </button>
                                                        <div className="text-right">
                                                            <span className={`block text-2xl font-black ${isLow ? 'text-neon-red' : isWarning ? 'text-yellow-400' : 'text-white'}`}>${cat.balance.toFixed(0)}</span>
                                                            <span className={`text-[10px] font-bold uppercase tracking-widest ${isLow ? 'text-neon-red' : isWarning ? 'text-yellow-400' : 'text-slate-500'}`}>
                                                                {isLow ? 'Overdrawn' : isWarning ? 'Low' : 'Left'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>

                                {/* Recent Transactions Preview */}
                                {transactions.filter(t => t.categoryId !== 'system').length > 0 && (
                                    <div className="glass-card p-5 rounded-3xl animate-enter">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wide flex items-center gap-2">
                                                <Icon name="activity" size={14} className="text-neon-blue" /> Recent
                                            </h3>
                                            <button onClick={() => setView('history')} className="text-xs text-neon-blue font-bold hover:underline">See all</button>
                                        </div>
                                        <div className="space-y-2">
                                            {transactions.filter(t => t.categoryId !== 'system').slice(0, 3).map(t => (
                                                <div key={t.id} className="flex justify-between items-center p-3 bg-glass-100 rounded-xl hover:bg-glass-200 transition-colors tap-feedback">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`p-2 rounded-lg ${t.type === 'income' ? 'bg-neon-green/20 text-neon-green' : 'bg-neon-red/20 text-neon-red'}`}>
                                                            <Icon name={t.type === 'income' ? 'arrow-down' : 'arrow-up'} size={14} />
                                                        </div>
                                                        <div>
                                                            <p className="font-medium text-white text-sm">{t.description}</p>
                                                            <p className="text-[10px] text-slate-500">{t.categoryName} â€¢ {new Date(t.date).toLocaleDateString('en-US', { weekday: 'short' })}</p>
                                                        </div>
                                                    </div>
                                                    <span className={`font-bold ${t.type === 'income' ? 'text-neon-green' : 'text-neon-red'}`}>
                                                        {t.type === 'income' ? '+' : '-'}${parseFloat(t.amount).toFixed(0)}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* AI AGENT */}
                        {view === 'ai' && (
                            <div className="animate-enter h-[75vh] flex flex-col glass-card rounded-[2.5rem] overflow-hidden border border-neon-blue/20 shadow-[0_0_50px_rgba(6,182,212,0.1)]">
                                <div className="bg-glass-100 p-4 border-b border-glass-200 font-bold text-center text-white flex items-center justify-center gap-2"><Icon name="sparkles" className="text-neon-blue" /> Gemini 3.0 Agent</div>
                                <div className="flex gap-2 p-3 px-4 overflow-x-auto hide-scrollbar border-b border-glass-100 bg-black/20">
                                    <button onClick={(e) => handleSendMessage(e, "Analyze my spending patterns and give me 3 hard truths.")} className="bg-glass-100 px-4 py-2 rounded-xl text-xs font-bold text-slate-300 hover:bg-neon-red hover:text-black transition-all border border-glass-200 whitespace-nowrap">ðŸ”¥ Roast Me</button>
                                    <button onClick={(e) => handleSendMessage(e, "Project my balance for next week based on trends.")} className="bg-glass-100 px-4 py-2 rounded-xl text-xs font-bold text-slate-300 hover:bg-neon-blue hover:text-black transition-all border border-glass-200 whitespace-nowrap">ðŸ”® Forecast</button>
                                    <button onClick={(e) => handleSendMessage(e, "Identify potential subscriptions or recurring bills I might have missed.")} className="bg-glass-100 px-4 py-2 rounded-xl text-xs font-bold text-slate-300 hover:bg-neon-purple hover:text-white transition-all border border-glass-200 whitespace-nowrap">ðŸ•µï¸ Subs Detective</button>
                                    <button onClick={(e) => handleSendMessage(e, "Create a 'Financial Persona' for me based on my spending habits. Be creative and fun!")} className="bg-glass-100 px-4 py-2 rounded-xl text-xs font-bold text-slate-300 hover:bg-yellow-400 hover:text-black transition-all border border-glass-200 whitespace-nowrap">ðŸŽ­ My Persona</button>
                                    <button onClick={(e) => handleSendMessage(e, "How can I cut costs without being miserable?")} className="bg-glass-100 px-4 py-2 rounded-xl text-xs font-bold text-slate-300 hover:bg-neon-green hover:text-black transition-all border border-white/10 whitespace-nowrap">ðŸ’° Save</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-5 space-y-6">
                                    {chatHistory.map((msg, i) => (
                                        <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed shadow-lg ${msg.role === 'user' ? 'bg-neon-blue text-black font-medium rounded-tr-none' : 'bg-glass-100 text-slate-200 rounded-tl-none border border-glass-200'}`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    ))}
                                    {isThinking && <div className="flex justify-start"><div className="bg-glass-100 p-4 rounded-2xl rounded-tl-none text-xs text-neon-blue font-bold animate-pulse border border-glass-200 flex items-center gap-2"><Icon name="loader" className="animate-spin" size={14} /> Reasoning...</div></div>}
                                    {reportCard && (
                                        <div className="bg-black/40 p-4 rounded-xl border border-neon-purple/30 text-sm leading-relaxed">
                                            <h3 className="text-neon-purple font-bold mb-2 flex items-center gap-2"><Icon name="file-text" size={16} /> Report Card</h3>
                                            <MarkdownText text={reportCard} />
                                        </div>
                                    )}
                                    <div ref={chatEndRef}></div>
                                </div>
                                <form onSubmit={handleSendMessage} className="p-4 bg-black/40 border-t border-glass-200 flex gap-3 backdrop-blur-xl">
                                    <input type="text" value={chatInput} onChange={e => setChatInput(e.target.value)} placeholder="Ask Gemini..." className="flex-1 p-4 rounded-2xl bg-glass-100 border border-glass-200 text-white text-sm focus:border-neon-blue focus:bg-glass-200 transition-all placeholder-slate-500" />
                                    <button type="submit" className="bg-neon-blue p-4 rounded-2xl text-black shadow-[0_0_20px_rgba(6,182,212,0.4)] hover:scale-105 transition-transform"><Icon name="send" size={20} /></button>
                                </form>
                            </div>
                        )}

                        {/* ADD & ACTIONS */}
                        {view === 'add' && (
                            <div className="glass-card p-6 rounded-[2.5rem] mt-4 animate-enter border-t border-glass-200 relative">
                                <h2 className="text-3xl font-black text-center mb-8 text-white tracking-tight">New Entry</h2>

                                <div className="grid grid-cols-2 gap-3 mb-8">
                                    <button onClick={() => receiptInputRef.current.click()} className="bg-glass-100 p-5 rounded-2xl flex flex-col items-center gap-2 hover:bg-glass-200 border border-glass-200 text-neon-blue transition-all group">
                                        <div className="p-3 bg-neon-blue/10 rounded-full group-hover:scale-110 transition-transform"><Icon name="scan-line" /></div>
                                        <span className="text-xs font-bold">Scan Receipt</span>
                                        {isThinking && <div className="absolute inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center rounded-2xl z-10"><Icon name="loader" className="animate-spin text-white" /></div>}
                                        <input type="file" ref={receiptInputRef} onChange={handleScan} className="hidden" accept="image/*" />
                                    </button>
                                    <button onClick={(e) => handleSendMessage(e, "I want to buy something for $___. Can I afford it based on my current balance and bills?")} className="bg-glass-100 p-5 rounded-2xl flex flex-col items-center gap-2 hover:bg-glass-200 border border-glass-200 text-neon-red transition-all group">
                                        <div className="p-3 bg-neon-red/10 rounded-full group-hover:scale-110 transition-transform"><Icon name="brain-circuit" /></div>
                                        <span className="text-xs font-bold">Can I Afford?</span>
                                    </button>
                                </div>

                                <div className="relative mb-8 group">
                                    <input type="text" value={magicText} onChange={e => setMagicText(e.target.value)} placeholder="Magic: 'Spent 50 on gas'" className="w-full p-5 bg-black/30 rounded-2xl border border-white/10 text-center text-sm font-bold text-white focus:border-neon-purple focus:bg-black/50 transition-all placeholder-slate-600" />
                                    <button onClick={handleMagic} className="absolute right-3 top-1/2 -translate-y-1/2 text-neon-purple p-2 hover:bg-glass-200 rounded-xl transition-all"><Icon name="sparkles" size={20} /></button>
                                </div>

                                <div className="flex bg-black/40 p-1.5 rounded-2xl mb-8 border border-glass-200">
                                    <button onClick={() => setNewTransaction({ ...newTransaction, type: 'expense' })} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${newTransaction.type === 'expense' ? 'bg-neon-red text-black shadow-[0_0_15px_rgba(255,0,85,0.4)]' : 'text-slate-500 hover:text-slate-300'}`}>Expense</button>
                                    <button onClick={() => setNewTransaction({ ...newTransaction, type: 'income' })} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${newTransaction.type === 'income' ? 'bg-neon-green text-black shadow-[0_0_15px_rgba(0,255,157,0.4)]' : 'text-slate-500 hover:text-slate-300'}`}>Income</button>
                                    <button onClick={() => setNewTransaction({ ...newTransaction, type: 'transfer' })} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${newTransaction.type === 'transfer' ? 'bg-neon-blue text-black shadow-[0_0_15px_rgba(6,182,212,0.4)]' : 'text-slate-500 hover:text-slate-300'}`}>Transfer</button>
                                </div>

                                {newTransaction.type === 'transfer' ? (
                                    <form onSubmit={handleTransfer} className="space-y-6">
                                        <div className="grid grid-cols-2 gap-4">
                                            <select className="w-full p-4 bg-black/30 border border-glass-200 rounded-2xl font-bold text-sm" value={transferData.fromId} onChange={e => setTransferData({ ...transferData, fromId: e.target.value })}><option value="">From</option>{categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>
                                            <select className="w-full p-4 bg-black/30 border border-glass-200 rounded-2xl font-bold text-sm" value={transferData.toId} onChange={e => setTransferData({ ...transferData, toId: e.target.value })}><option value="">To</option>{categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>
                                        </div>
                                        <input type="number" step="0.01" className="w-full p-6 bg-black/30 border border-glass-200 rounded-3xl font-black text-4xl text-center text-white focus:border-neon-blue transition-all" placeholder="$0.00" value={transferData.amount} onChange={e => setTransferData({ ...transferData, amount: e.target.value })} />
                                        <button type="submit" className="w-full py-5 bg-neon-blue hover:bg-cyan-400 text-black font-bold rounded-2xl shadow-[0_0_20px_rgba(6,182,212,0.3)] transition-all mt-2 text-lg">Move Funds</button>
                                    </form>
                                ) : (
                                    <form onSubmit={handleAdd} className="space-y-6">
                                        <div className="grid grid-cols-4 gap-2">{categories.map(c => <button type="button" key={c.id} onClick={() => setNewTransaction({ ...newTransaction, categoryId: c.id })} className={`p-3 rounded-2xl border flex flex-col items-center gap-1.5 transition-all tap-feedback ${newTransaction.categoryId === c.id ? 'border-neon-green bg-green-500/10 text-green-300 shadow-[0_0_15px_rgba(0,255,157,0.15)]' : 'border-glass-200 bg-glass-100 text-slate-500 hover:bg-glass-200'}`}><span className="text-lg"><Icon name={c.icon} size={20} /></span><span className="text-[10px] font-bold truncate w-full text-center">{c.name}</span></button>)}</div>

                                        {/* Quick Amount Presets */}
                                        <div className="flex gap-2 justify-center">
                                            {[5, 10, 20, 50].map(amt => (
                                                <button key={amt} type="button" onClick={() => setNewTransaction({ ...newTransaction, amount: amt.toString() })}
                                                    className={`px-4 py-2 rounded-xl text-sm font-bold transition-all tap-feedback ${newTransaction.amount === amt.toString() ? 'bg-neon-green text-black' : 'bg-glass-100 text-slate-400 hover:bg-glass-200 border border-glass-200'}`}>
                                                    ${amt}
                                                </button>
                                            ))}
                                        </div>

                                        <div className="relative group">
                                            <span className="absolute left-6 top-1/2 -translate-y-1/2 font-bold text-2xl text-slate-500">$</span>
                                            <input type="number" step="0.01" required value={newTransaction.amount} onChange={(e) => setNewTransaction({ ...newTransaction, amount: e.target.value })} className="w-full pl-12 pr-16 py-6 text-5xl font-black text-white bg-black/30 border border-glass-200 rounded-3xl focus:border-neon-green focus:shadow-[0_0_20px_rgba(0,255,157,0.1)] outline-none transition-all placeholder-slate-700 text-center" placeholder="0" />
                                            <button type="button" onClick={handleVoiceInput} className={`absolute right-4 top-1/2 -translate-y-1/2 p-2 rounded-xl transition-all tap-feedback ${isListening ? 'bg-neon-red text-white animate-pulse' : 'bg-glass-100 text-slate-400 hover:text-neon-blue'}`}>
                                                <Icon name="mic" size={20} />
                                            </button>
                                        </div>

                                        {/* Common descriptions quick-select */}
                                        {newTransaction.categoryId && (
                                            <div className="flex gap-2 flex-wrap justify-center">
                                                {['Food', 'Gas', 'Coffee', 'Shopping', 'Bills'].slice(0, 4).map(desc => (
                                                    <button key={desc} type="button" onClick={() => setNewTransaction({ ...newTransaction, description: desc })}
                                                        className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${newTransaction.description === desc ? 'bg-neon-purple/20 text-neon-purple border-neon-purple/30' : 'bg-glass-100 text-slate-500 hover:text-slate-300'} border border-glass-200`}>
                                                        {desc}
                                                    </button>
                                                ))}
                                            </div>
                                        )}

                                        <input type="text" value={newTransaction.description} onChange={(e) => setNewTransaction({ ...newTransaction, description: e.target.value })} className="w-full p-4 font-semibold text-white bg-black/30 border border-glass-200 rounded-2xl focus:border-neon-green/50 outline-none transition-all placeholder-slate-600 text-center" placeholder="Add a note..." />
                                        <button type="submit" disabled={!newTransaction.categoryId || !newTransaction.amount} className={`w-full py-5 text-lg text-black font-bold rounded-2xl shadow-lg flex items-center justify-center gap-3 transition-all tap-feedback ${newTransaction.type === 'income' ? 'bg-neon-green shadow-[0_0_20px_rgba(0,255,157,0.3)]' : 'bg-neon-red shadow-[0_0_20px_rgba(255,0,85,0.3)] text-white'} disabled:opacity-50 disabled:shadow-none`}>Save Transaction <Icon name="check" size={20} /></button>
                                    </form>
                                )}
                            </div>
                        )}

                        {/* HISTORY */}
                        {view === 'history' && (
                            <div className="animate-enter space-y-4">
                                <div className="flex justify-between items-center px-1"><h2 className="text-3xl font-black text-white tracking-tight">History</h2></div>
                                <div className="relative">
                                    <Icon name="search" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" />
                                    <input type="text" placeholder="Search..." className="w-full pl-12 pr-10 p-4 bg-black/30 border border-glass-200 rounded-2xl text-white font-bold focus:border-neon-blue/50 outline-none transition-all" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                                    {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white"><Icon name="x" size={16} /></button>}
                                </div>
                                <div className="space-y-3 pb-24">
                                    {filteredTx.length === 0 ? <div className="text-center py-20 text-slate-600">No results found</div> : filteredTx.map(t => (
                                        <div key={t.id} className="glass-card p-4 rounded-2xl flex justify-between items-center shadow-sm hover:bg-glass-200 transition-colors border border-glass-200">
                                            <div className="flex items-center gap-4">
                                                <div className={`p-3 rounded-2xl ${t.type === 'income' ? 'bg-neon-green/10 text-neon-green' : t.type === 'transfer' ? 'bg-neon-blue/10 text-neon-blue' : 'bg-neon-red/10 text-neon-red'}`}>
                                                    <Icon name={t.categoryId === 'system' ? 'rss' : t.type === 'income' ? 'arrow-down' : t.type === 'transfer' ? 'arrow-right-left' : 'arrow-up'} size={20} />
                                                </div>
                                                <div>
                                                    <p className="font-bold text-white text-sm">{t.description}</p>
                                                    <p className="text-xs text-slate-500 mt-0.5 font-medium">{new Date(t.date).toLocaleDateString()} â€¢ {t.categoryName}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className={`font-black text-lg tracking-tight ${t.type === 'income' ? 'text-neon-green' : t.type === 'transfer' ? 'text-neon-blue' : 'text-neon-red'}`}>
                                                    {t.type === 'income' ? '+' : t.type === 'transfer' ? '' : '-'}${parseFloat(t.amount).toFixed(2)}
                                                </span>
                                                <button onClick={() => { if (confirm('Delete?')) handleDelete(t.id) }} className="text-slate-600 hover:text-neon-red p-2 transition-colors"><Icon name="trash-2" size={18} /></button>
                                                <button onClick={() => handleClone(t)} className="text-slate-600 hover:text-neon-blue p-2 transition-colors"><Icon name="copy" size={18} /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* SETTINGS */}
                        {view === 'settings' && (
                            <div className="animate-enter space-y-6">
                                <h2 className="text-3xl font-black text-white tracking-tight">Settings</h2>
                                <div className="glass-card p-6 rounded-3xl border border-neon-purple/30 relative overflow-hidden">
                                    <label className="text-xs font-bold text-neon-purple uppercase mb-3 block flex items-center gap-2"><Icon name="key" size={12} /> Gemini API Key</label>
                                    <input type="password" value={geminiKey} onChange={e => { setGeminiKey(e.target.value); localStorage.setItem('gemini_key', e.target.value); }} placeholder="Paste Key..." className="w-full p-4 bg-black/50 border border-glass-200 rounded-xl text-white text-sm mb-4 font-mono focus:border-neon-purple transition-all" />
                                    <label className="text-xs font-bold text-neon-purple uppercase mb-3 block">Model Version</label>
                                    <select value={aiModel} onChange={e => { setAiModel(e.target.value); localStorage.setItem('ai_model', e.target.value); }} className="w-full p-4 bg-black/50 border border-glass-200 rounded-xl text-white text-sm font-bold appearance-none">
                                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fast)</option>
                                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Smart)</option>
                                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Exp)</option>
                                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (Future)</option>
                                        <option value="gemini-3.0-flash-preview">Gemini 3.0 Flash (Alpha)</option>
                                        <option value="gemini-3.0-pro-preview">Gemini 3.0 Pro (Alpha)</option>
                                    </select>
                                </div>
                                <button onClick={handleTuneUp} className="w-full glass-card p-5 rounded-2xl text-neon-purple font-bold text-sm flex items-center justify-center gap-2 border-neon-purple/30 hover:bg-neon-purple/10 hover:scale-[1.02] transition-all"><Icon name="sliders" /> Auto-Tune Budget (Agent)</button>
                                {showTuneUp && tuneUpProposals && (<div className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-6 backdrop-blur-xl animate-enter"><div className="bg-glass-nav border border-neon-purple/50 rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl overflow-y-auto max-h-[80vh]"><h3 className="text-2xl font-black text-white mb-6">AI Proposals</h3><div className="space-y-4 mb-8">{tuneUpProposals.map(p => { const cat = categories.find(c => c.id === p.id); return (<div key={p.id} className="bg-glass-100 p-4 rounded-2xl border border-glass-200"><div className="flex justify-between font-bold text-slate-200 text-lg"><span>{cat?.name}</span> <span className="text-neon-blue">${p.newLimit}</span></div><div className="text-sm text-slate-400 mt-2 leading-relaxed">{p.reason}</div></div>); })}</div><div className="flex gap-3"><button onClick={() => { setShowTuneUp(false); setTuneUpProposals(null); }} className="flex-1 py-4 text-slate-400 font-bold bg-glass-100 rounded-2xl">Cancel</button><button onClick={applyTuneUp} className="flex-1 py-4 text-black bg-neon-blue font-bold rounded-2xl shadow-lg">Apply</button></div></div></div>)}
                                <div className="grid grid-cols-2 gap-3"><button onClick={handleBackup} className="glass-card p-4 rounded-2xl text-xs font-bold text-neon-green flex flex-col items-center gap-2 hover:bg-neon-green/10 border-neon-green/20 transition-all"><Icon name="save" /> Backup Data</button><button onClick={() => fileInputRef.current.click()} className="glass-card p-4 rounded-2xl text-xs font-bold text-neon-blue flex flex-col items-center gap-2 hover:bg-neon-blue/10 border-neon-blue/20 transition-all"><Icon name="upload-cloud" /> Restore Data <input type="file" ref={fileInputRef} onChange={handleRestore} className="hidden" /></button></div>
                                <div className="grid grid-cols-2 gap-3"><button onClick={handlePrint} className="glass-card p-4 rounded-2xl text-xs font-bold text-slate-300 flex flex-col items-center gap-2 hover:bg-white/10 border-glass-200 transition-all"><Icon name="printer" /> Print / PDF</button><button onClick={handleExport} className="glass-card p-4 rounded-2xl text-xs font-bold text-slate-300 flex flex-col items-center gap-2 hover:bg-white/10 border-glass-200 transition-all"><Icon name="download" /> Export CSV</button></div>
                                <div className="flex justify-between items-end px-2 pt-4 pb-2"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Envelopes</h3><button onClick={() => setShowAddCat(true)} className="text-xs font-bold text-white bg-glass-100 px-4 py-1.5 rounded-full hover:bg-glass-200 transition-colors">+ New</button></div>
                                <div className="space-y-3 pb-24">{categories.map(cat => (<div key={cat.id} className="glass-card p-4 rounded-2xl flex flex-col gap-3"><div className="flex justify-between items-center w-full"><div className="flex items-center gap-4"><div className="text-2xl opacity-80 text-slate-400"><Icon name={cat.icon} /></div><div><p className="font-bold text-slate-200">{cat.name}</p><p className="text-xs text-slate-500 font-bold uppercase">{cat.frequency}</p></div></div><button onClick={() => { setEditingCategory(cat.id); setEditForm({ limit: cat.limit, balance: cat.balance, name: cat.name }); }} className="bg-glass-100 px-4 py-2 rounded-xl text-xs font-bold text-slate-400 flex items-center gap-2 border border-glass-200 hover:text-white">Edit <Icon name="edit-2" size={12} className="opacity-50" /></button></div>{editingCategory === cat.id && (<div className="bg-black/30 p-4 rounded-2xl border border-glass-200 mt-2 animate-enter"><div className="mb-3"><label className="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Name</label><input type="text" className="w-full pl-4 p-3 rounded-xl bg-black/50 border border-glass-200 font-bold text-white outline-none focus:border-neon-blue" value={editForm.name} onChange={e => setEditForm({ ...editForm, name: e.target.value })} /></div><div className="grid grid-cols-2 gap-4 mb-4"><div><label className="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Balance</label><input type="number" className="w-full pl-4 p-3 rounded-xl bg-black/50 border border-glass-200 font-bold text-white outline-none focus:border-neon-blue" value={editForm.balance} onChange={e => setEditForm({ ...editForm, balance: e.target.value })} /></div><div><label className="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Limit</label><input type="number" className="w-full pl-4 p-3 rounded-xl bg-black/50 border border-glass-200 font-bold text-white outline-none focus:border-neon-blue" value={editForm.limit} onChange={e => setEditForm({ ...editForm, limit: e.target.value })} /></div></div><div className="flex gap-2"><button onClick={() => handleDeleteCategory(cat.id)} className="p-3 text-neon-red bg-neon-red/10 rounded-xl hover:bg-neon-red/20"><Icon name="trash-2" size={18} /></button><button onClick={() => setEditingCategory(null)} className="flex-1 py-3 font-bold text-slate-400 hover:bg-glass-100 rounded-xl">Cancel</button><button onClick={() => handleUpdateCat(cat.id)} className="flex-1 py-3 bg-neon-blue text-black font-bold rounded-xl shadow-md hover:bg-cyan-400">Save</button></div></div>)}</div>))}</div>
                                <div className="pt-8 pb-8"><button onClick={() => setShowResetConfirm(true)} className="w-full p-5 text-neon-red bg-neon-red/10 border border-neon-red/20 rounded-2xl font-bold flex justify-center gap-2 hover:bg-neon-red/20 transition-colors"><Icon name="trash-2" /> Reset All Data</button></div>
                            </div>
                        )}

                        {/* BREAKDOWN */}
                        {view === 'breakdown' && (
                            <div className="animate-enter space-y-6">
                                {/* Header with Month Selector */}
                                <div className="flex justify-between items-center px-1">
                                    <h2 className="text-3xl font-black text-white tracking-tight">Analytics</h2>
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={() => { const d = new Date(selectedMonth); d.setMonth(d.getMonth() - 1); setSelectedMonth(d); }}
                                            className="p-2 bg-glass-100 rounded-xl text-slate-400 hover:text-white border border-glass-200"
                                        ><Icon name="chevron-left" size={16} /></button>
                                        <span className="text-sm font-bold text-slate-300 min-w-[100px] text-center">
                                            {selectedMonth.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
                                        </span>
                                        <button
                                            onClick={() => { const d = new Date(selectedMonth); d.setMonth(d.getMonth() + 1); setSelectedMonth(d); }}
                                            className="p-2 bg-glass-100 rounded-xl text-slate-400 hover:text-white border border-glass-200"
                                        ><Icon name="chevron-right" size={16} /></button>
                                    </div>
                                </div>

                                {/* Summary Cards */}
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="glass-card p-5 rounded-2xl">
                                        <div className="text-slate-500 text-xs font-bold uppercase mb-1">Total Spent</div>
                                        <div className="text-3xl font-black text-white">${selectedMonthTotal.toFixed(0)}</div>
                                        {monthComparison.totalChange !== 0 && (
                                            <div className={`text-xs font-bold mt-1 flex items-center gap-1 ${monthComparison.totalChange > 0 ? 'text-neon-red' : 'text-neon-green'}`}>
                                                <Icon name={monthComparison.totalChange > 0 ? 'trending-up' : 'trending-down'} size={12} />
                                                {Math.abs(monthComparison.totalChange).toFixed(0)}% vs last month
                                            </div>
                                        )}
                                    </div>
                                    <div className="glass-card p-5 rounded-2xl">
                                        <div className="text-slate-500 text-xs font-bold uppercase mb-1">Daily Average</div>
                                        <div className="text-3xl font-black text-white">${dailyAvg.toFixed(0)}</div>
                                        <div className={`text-xs font-bold mt-1 ${dailyAvg > targetDaily ? 'text-neon-red' : 'text-neon-green'}`}>
                                            Target: ${targetDaily.toFixed(0)}/day
                                        </div>
                                    </div>
                                </div>

                                {/* Donut Chart with Category Breakdown */}
                                <div className="glass-card p-6 rounded-3xl">
                                    <div className="mb-4 font-bold text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wide">
                                        <Icon name="pie-chart" size={18} className="text-neon-blue" /> Where Your Money Goes
                                    </div>

                                    {categorySpending.length > 0 ? (
                                        <div className="flex flex-col md:flex-row items-center gap-6">
                                            {/* SVG Donut Chart */}
                                            <div className="relative w-48 h-48 flex-shrink-0">
                                                <svg viewBox="0 0 100 100" className="w-full h-full -rotate-90">
                                                    {(() => {
                                                        const colors = ['#00ff9d', '#00f0ff', '#bd00ff', '#ff0055', '#facc15', '#ec4899'];
                                                        let cumulative = 0;
                                                        return categorySpending.map((cat, i) => {
                                                            const radius = 35;
                                                            const circumference = 2 * Math.PI * radius;
                                                            const strokeLength = (cat.percentage / 100) * circumference;
                                                            const strokeOffset = (cumulative / 100) * circumference;
                                                            cumulative += cat.percentage;
                                                            return (
                                                                <circle
                                                                    key={cat.name}
                                                                    cx="50" cy="50" r={radius}
                                                                    fill="none"
                                                                    stroke={colors[i % colors.length]}
                                                                    strokeWidth="12"
                                                                    strokeDasharray={`${strokeLength} ${circumference - strokeLength}`}
                                                                    strokeDashoffset={-strokeOffset}
                                                                    className="transition-all duration-700 hover:opacity-80 cursor-pointer"
                                                                    style={{ filter: `drop-shadow(0 0 8px ${colors[i % colors.length]}40)` }}
                                                                    onClick={() => setSelectedCategory(selectedCategory === cat.name ? null : cat.name)}
                                                                />
                                                            );
                                                        });
                                                    })()}
                                                </svg>
                                                <div className="absolute inset-0 flex flex-col items-center justify-center">
                                                    <span className="text-3xl font-black text-white">${selectedMonthTotal.toFixed(0)}</span>
                                                    <span className="text-xs text-slate-400 font-medium">Total</span>
                                                </div>
                                            </div>

                                            {/* Category Legend */}
                                            <div className="flex-1 space-y-2 w-full">
                                                {categorySpending.slice(0, 5).map((cat, i) => {
                                                    const colors = ['bg-neon-green', 'bg-neon-blue', 'bg-neon-purple', 'bg-neon-red', 'bg-yellow-400'];
                                                    const isSelected = selectedCategory === cat.name;
                                                    return (
                                                        <div
                                                            key={cat.name}
                                                            onClick={() => setSelectedCategory(isSelected ? null : cat.name)}
                                                            className={`flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${isSelected ? 'bg-glass-200 scale-[1.02]' : 'hover:bg-glass-100'}`}
                                                        >
                                                            <div className="flex items-center gap-3 min-w-0 flex-1">
                                                                <div className={`w-3 h-3 rounded-full flex-shrink-0 ${colors[i % colors.length]}`}></div>
                                                                <Icon name={cat.icon} size={14} className="text-slate-400 flex-shrink-0" />
                                                                <span className="font-medium text-slate-200 text-sm truncate">{cat.name}</span>
                                                            </div>
                                                            <div className="flex items-center gap-2 flex-shrink-0 ml-3">
                                                                <span className="font-bold text-white">${cat.amount.toFixed(0)}</span>
                                                                <span className="text-slate-500 text-xs bg-glass-100 px-2 py-0.5 rounded">{cat.percentage.toFixed(0)}%</span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-10 text-slate-500">No spending data for this month</div>
                                    )}
                                </div>

                                {/* Daily Spending Bar Chart with Range Toggle */}
                                <div className="glass-card p-6 rounded-3xl">
                                    <div className="mb-4 flex items-center justify-between">
                                        <span className="font-bold text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wide">
                                            <Icon name="bar-chart-3" size={18} className="text-neon-purple" /> Daily Spending
                                        </span>
                                        <div className="flex gap-1 bg-glass-100 rounded-lg p-1">
                                            {[7, 14, 30].map(range => (
                                                <button
                                                    key={range}
                                                    onClick={() => setChartRange(range)}
                                                    className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${chartRange === range ? 'bg-neon-purple text-black' : 'text-slate-400 hover:text-white'}`}
                                                >{range}D</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="text-xs text-slate-500 mb-3 flex justify-between">
                                        <span>Avg: <span className="text-white font-bold">${dailySpendingData.avg.toFixed(0)}</span>/day</span>
                                        <span>Max: <span className="text-neon-red font-bold">${dailySpendingData.max.toFixed(0)}</span></span>
                                    </div>
                                    <div className="flex items-end justify-between h-32 gap-0.5 overflow-x-auto">
                                        {dailySpendingData.days.map((d, i) => {
                                            const isToday = i === dailySpendingData.days.length - 1;
                                            const barColor = d.isAboveAvg ? 'bg-neon-red' : 'bg-neon-green';
                                            return (
                                                <div key={i} className="flex flex-col items-center gap-1 flex-1 min-w-[12px] group relative">
                                                    <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-black/90 px-2 py-1 rounded text-[10px] font-bold text-white opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                                        ${d.total.toFixed(0)}
                                                    </div>
                                                    <div className="w-full relative h-24 flex items-end">
                                                        <div
                                                            className={`w-full rounded-t transition-all duration-500 ${barColor} ${isToday ? 'shadow-[0_0_15px_currentColor]' : ''}`}
                                                            style={{ height: `${Math.max(d.pct, 4)}%`, opacity: isToday ? 1 : 0.7 }}
                                                        ></div>
                                                    </div>
                                                    {chartRange <= 14 && <span className={`text-[8px] font-bold ${isToday ? 'text-white' : 'text-slate-600'}`}>{d.dayNum}</span>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* Smart Insights */}
                                <div className="glass-card p-5 rounded-3xl">
                                    <div className="mb-3 font-bold text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wide">
                                        <Icon name="sparkles" size={18} className="text-yellow-400" /> Smart Insights
                                    </div>
                                    <div className="space-y-2">
                                        {spendingInsights.map((insight, i) => (
                                            <div key={i} className={`flex items-start gap-3 p-3 bg-glass-100 rounded-xl ${insight.color}`}>
                                                <Icon name={insight.icon} size={16} className="mt-0.5 flex-shrink-0" />
                                                <span className="text-sm text-slate-300">{insight.text}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <button
                                        onClick={handleReportCard}
                                        className="w-full mt-4 p-3 bg-glass-100 hover:bg-neon-purple/20 rounded-xl text-neon-purple font-bold text-sm flex items-center justify-center gap-2 border border-neon-purple/30 transition-all"
                                    >
                                        <Icon name="brain" size={16} /> Get AI Deep Analysis
                                    </button>
                                </div>

                                {/* Month Comparison */}
                                {monthComparison.categories.length > 0 && (
                                    <div className="glass-card p-5 rounded-3xl">
                                        <div className="mb-4 font-bold text-slate-300 flex items-center justify-between text-sm uppercase tracking-wide">
                                            <span className="flex items-center gap-2"><Icon name="git-compare" size={18} className="text-neon-green" /> vs Last Month</span>
                                            <span className={`text-xs normal-case ${monthComparison.totalChange > 0 ? 'text-neon-red' : 'text-neon-green'}`}>
                                                {monthComparison.totalChange > 0 ? '+' : ''}{monthComparison.totalChange.toFixed(0)}% overall
                                            </span>
                                        </div>
                                        <div className="space-y-2">
                                            {monthComparison.categories.slice(0, 5).map(cat => (
                                                <div key={cat.name} className="flex items-center justify-between p-3 bg-glass-100 rounded-xl">
                                                    <div className="flex items-center gap-3">
                                                        <Icon name={cat.icon} size={16} className="text-slate-400" />
                                                        <span className="text-sm font-medium text-slate-300">{cat.name}</span>
                                                    </div>
                                                    <div className="flex items-center gap-3 text-sm">
                                                        <span className="text-slate-500">${cat.previous.toFixed(0)}</span>
                                                        <Icon name="arrow-right" size={12} className="text-slate-600" />
                                                        <span className="font-bold text-white">${cat.current.toFixed(0)}</span>
                                                        <span className={`text-xs font-bold px-2 py-0.5 rounded ${cat.change > 0 ? 'bg-neon-red/20 text-neon-red' : 'bg-neon-green/20 text-neon-green'}`}>
                                                            {cat.change > 0 ? '+' : ''}{cat.change.toFixed(0)}%
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Monthly History */}
                                {monthlyBreakdown.length > 0 && (
                                    <div className="space-y-4">
                                        <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wide px-1">Monthly History</h3>
                                        {monthlyBreakdown.slice(0, 3).map(([month, data]) => (
                                            <div key={month} className="glass-card rounded-2xl overflow-hidden">
                                                <div className="p-4 bg-white/5 border-b border-white/5 flex justify-between items-center">
                                                    <span className="font-bold text-slate-200">{month}</span>
                                                    <span className="bg-neon-purple/20 text-purple-300 px-3 py-1 rounded-full text-sm">${data.total.toFixed(0)}</span>
                                                </div>
                                                <div className="p-2">
                                                    {Object.entries(data.cats).sort((a, b) => b[1] - a[1]).slice(0, 4).map(([c, amt]) => (
                                                        <div key={c} className="flex justify-between items-center p-2 text-sm">
                                                            <span className="text-slate-400">{c}</span>
                                                            <span className="font-bold text-slate-200">${amt.toFixed(0)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {showAddCat && (<div className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-6 backdrop-blur-xl animate-enter"><div className="bg-glass-nav border border-glass-200 rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl"><h2 className="text-2xl font-black mb-6 text-white text-center">New Envelope</h2><div className="space-y-4"><input type="text" placeholder="Name (e.g. Pets)" className="w-full p-4 bg-black/50 border border-glass-200 rounded-2xl font-bold text-white outline-none focus:border-neon-purple" value={newCatForm.name} onChange={e => setNewCatForm({ ...newCatForm, name: e.target.value })} /><input type="number" placeholder="Limit ($)" className="w-full p-4 bg-black/50 border border-glass-200 rounded-2xl font-bold text-white outline-none focus:border-neon-purple" value={newCatForm.limit} onChange={e => setNewCatForm({ ...newCatForm, limit: e.target.value })} /><div className="grid grid-cols-5 gap-2 my-4">{AVAILABLE_ICONS.map(ic => (<button key={ic} onClick={() => setNewCatForm({ ...newCatForm, icon: ic })} className={`p-3 rounded-xl flex justify-center transition-all ${newCatForm.icon === ic ? 'bg-neon-purple text-white shadow-lg' : 'bg-glass-100 text-slate-500'}`}><Icon name={ic} size={18} /></button>))}</div><div className="flex gap-3"><button onClick={() => setShowAddCat(false)} className="flex-1 py-4 text-slate-500 font-bold hover:bg-glass-100 rounded-2xl">Cancel</button><button onClick={handleCreateCategory} disabled={!newCatForm.name || !newCatForm.limit} className="flex-1 py-4 bg-neon-purple text-white rounded-2xl font-bold shadow-lg disabled:opacity-50">Create</button></div></div></div></div>)}

                    {showWeekModal && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-enter">
                            <div className="bg-glass-nav border border-white/10 rounded-[2rem] p-6 w-full max-w-sm shadow-2xl max-h-[80vh] overflow-y-auto">
                                <h2 className="text-2xl font-black mb-2 text-white">Start Cycle {weeksTracked + 1}?</h2>
                                <p className="text-slate-400 mb-4 text-sm">Rollover preview (max 50% positive, full negative):</p>

                                <div className="space-y-2 mb-4">
                                    {categories.filter(c => c.frequency === 'weekly' || (c.frequency === 'monthly' && isNewMonth)).map(cat => {
                                        const maxRollover = cat.limit * 0.5;
                                        const rollover = cat.balance < 0 ? cat.balance : Math.min(cat.balance, maxRollover);
                                        const newBalance = cat.limit + rollover;
                                        return (
                                            <div key={cat.id} className="bg-glass-100 p-3 rounded-xl flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    <Icon name={cat.icon} size={16} className="text-slate-400" />
                                                    <span className="text-sm font-medium text-slate-300">{cat.name}</span>
                                                </div>
                                                <div className="text-right text-xs">
                                                    <span className={rollover >= 0 ? 'text-neon-green' : 'text-neon-red'}>{rollover >= 0 ? '+' : ''}{rollover.toFixed(0)}</span>
                                                    <span className="text-slate-500 mx-1">â†’</span>
                                                    <span className="text-white font-bold">${newBalance.toFixed(0)}</span>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                <div className="bg-indigo-500/10 p-4 rounded-2xl mb-4 flex gap-3 items-center border border-indigo-500/20">
                                    <input type="checkbox" className="w-5 h-5 rounded-lg text-neon-purple bg-dark-800 border-white/20" checked={isNewMonth} onChange={e => setIsNewMonth(e.target.checked)} />
                                    <span className="font-bold text-indigo-200 text-sm">New Month? <span className="font-normal text-indigo-300/50 block text-xs">Also refills monthly categories</span></span>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => setShowWeekModal(false)} className="flex-1 py-4 font-bold text-slate-500 bg-glass-100 rounded-2xl hover:bg-glass-200">Cancel</button>
                                    <button onClick={handleWeekReset} className="flex-1 py-4 font-bold text-white bg-neon-purple rounded-2xl shadow-xl hover:bg-purple-500 transition-all shadow-[0_0_20px_rgba(168,85,247,0.3)]">Confirm</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-8 left-0 right-0 flex justify-center z-40 pointer-events-none no-print">
                        <nav className="glass-nav rounded-[2rem] p-2 flex gap-2 pointer-events-auto transition-all shadow-2xl scale-100">
                            <button onClick={() => setView('dashboard')} className={`p-4 rounded-2xl transition-all duration-300 ${view === 'dashboard' ? 'bg-neon-green text-black shadow-[0_0_20px_rgba(0,255,157,0.4)] scale-110' : 'text-slate-500 hover:text-slate-300 hover:bg-glass-100'}`}><Icon name="layout-dashboard" /></button>
                            <button onClick={() => setView('breakdown')} className={`p-4 rounded-2xl transition-all duration-300 ${view === 'breakdown' ? 'bg-neon-blue text-black shadow-[0_0_20px_rgba(0,240,255,0.4)] scale-110' : 'text-slate-500 hover:text-slate-300 hover:bg-glass-100'}`}><Icon name="pie-chart" /></button>
                            <button onClick={() => setView('add')} className={`bg-white text-black p-4 rounded-2xl shadow-[0_0_30px_rgba(255,255,255,0.4)] hover:scale-110 active:scale-95 transition-all mx-2 ${view === 'dashboard' ? 'fab-pulse' : ''}`}><Icon name="plus" size={32} strokeWidth={3} /></button>
                            <button onClick={() => setView('history')} className={`p-4 rounded-2xl transition-all duration-300 ${view === 'history' ? 'bg-neon-red text-white shadow-[0_0_20px_rgba(255,0,85,0.4)] scale-110' : 'text-slate-500 hover:text-slate-300 hover:bg-glass-100'}`}><Icon name="history" /></button>
                            <button onClick={() => setView('settings')} className={`p-4 rounded-2xl transition-all duration-300 ${view === 'settings' ? 'bg-neon-purple text-white shadow-[0_0_20px_rgba(189,0,255,0.4)] scale-110' : 'text-slate-500 hover:text-slate-300 hover:bg-glass-100'}`}><Icon name="settings" /></button>
                        </nav>
                    </div>

                    {/* Toast Notification */}
                    <div className={`toast ${toast.show ? 'show' : ''} ${toast.error ? 'error' : ''}`}>
                        {toast.message}
                    </div>

                    {/* Confetti Celebration */}
                    {showConfetti && (
                        <div className="confetti-container">
                            {[...Array(30)].map((_, i) => (
                                <div
                                    key={i}
                                    className="confetti"
                                    style={{
                                        left: `${Math.random() * 100}%`,
                                        backgroundColor: ['#00ff9d', '#00f0ff', '#bd00ff', '#ff0055', '#facc15'][Math.floor(Math.random() * 5)],
                                        animationDelay: `${Math.random() * 0.5}s`,
                                        borderRadius: Math.random() > 0.5 ? '50%' : '0'
                                    }}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
